{"version":3,"file":"translator.min.js","sources":["../src/translator.js"],"sourcesContent":["// local/xlate/amd/src/translator.js\ndefine([], function () {\n  /**\n   * Translate a single element when metadata is present.\n   * @param {Element} node DOM node to translate.\n   * @param {Object<string, string>} map Translation map.\n   * @returns {void}\n   */\n  function translateNode(node, map) {\n    if (node.nodeType !== 1) {\n      return;\n    }\n    var key = node.getAttribute && node.getAttribute('data-xlate');\n    if (key && map[key]) {\n      node.textContent = map[key];\n    }\n    ['placeholder', 'title', 'alt', 'aria-label'].forEach(function (attr) {\n      var akey = node.getAttribute && node.getAttribute('data-xlate-' + attr);\n      if (akey && map[akey]) {\n        node.setAttribute(attr, map[akey]);\n      }\n    });\n  }\n\n  /**\n   * Walk the DOM depth-first and translate every eligible child.\n   * @param {Element} root Root element to process.\n   * @param {Object<string, string>} map Translation map.\n   * @returns {void}\n   */\n  function walk(root, map) {\n    var stack = [root];\n    while (stack.length) {\n      var el = stack.pop();\n      if (el.nodeType === 1) {\n        if (el.hasAttribute && el.hasAttribute('data-xlate-ignore')) {\n          continue;\n        }\n        translateNode(el, map);\n        var children = el.children || [];\n        for (var i = 0; i < children.length; i++) {\n          stack.push(children[i]);\n        }\n      }\n    }\n  }\n\n  /**\n   * Entry point: translates current DOM and observes future updates.\n   * @param {Object<string, string>} map Translation map.\n   * @returns {void}\n   */\n  function run(map) {\n    try {\n      walk(document.body, map || {});\n      var mo = new MutationObserver(function (muts) {\n        muts.forEach(function (m) {\n          (m.addedNodes || []).forEach(function (n) {\n            if (n.nodeType === 1) {\n              walk(n, map || {});\n            }\n          });\n        });\n      });\n      mo.observe(document.body, { childList: true, subtree: true });\n    } finally {\n      document.documentElement.classList.remove('xlate-loading');\n    }\n  }\n\n  /**\n   * Initialize the translator with config from Moodle.\n   * @param {Object} config Configuration object with lang, version, bundleurl.\n   * @returns {void}\n   */\n  function init(config) {\n    document.documentElement.classList.add('xlate-loading');\n    var k = 'xlate:' + config.lang + ':' + config.version;\n\n    window.__XLATE__ = { lang: config.lang, map: {} };\n\n    try {\n      var cached = localStorage.getItem(k);\n      if (cached) {\n        var bundle = JSON.parse(cached);\n        window.__XLATE__.map = bundle;\n        run(bundle);\n      }\n\n      fetch(config.bundleurl, { credentials: 'same-origin' })\n        .then(function (r) {\n          return r.json();\n        })\n        .then(function (bundle) {\n          try {\n            localStorage.setItem(k, JSON.stringify(bundle));\n          } catch (e) {\n            // Storage quota exceeded, ignore\n          }\n          if (!cached) {\n            window.__XLATE__.map = bundle;\n            run(bundle);\n          }\n        })\n        .catch(function () {\n          if (!cached) {\n            run({});\n          }\n        });\n    } catch (e) {\n      fetch(config.bundleurl)\n        .then(function (r) {\n          return r.json();\n        })\n        .then(function (bundle) {\n          window.__XLATE__.map = bundle;\n          run(bundle);\n        })\n        .catch(function () {\n          run({});\n        });\n    }\n  }\n\n  return {\n    run: run,\n    init: init\n  };\n});"],"names":["define","translateNode","node","map","nodeType","key","getAttribute","textContent","forEach","attr","akey","setAttribute","walk","root","stack","length","el","pop","hasAttribute","children","i","push","run","document","body","MutationObserver","muts","m","addedNodes","n","observe","childList","subtree","documentElement","classList","remove","init","config","add","k","lang","version","window","__XLATE__","cached","localStorage","getItem","bundle","JSON","parse","fetch","bundleurl","credentials","then","r","json","setItem","stringify","e","catch"],"mappings":"AACAA,gCAAO,IAAI,oBAOAC,cAAcC,KAAMC,QACL,IAAlBD,KAAKE,cAGLC,IAAMH,KAAKI,cAAgBJ,KAAKI,aAAa,cAC7CD,KAAOF,IAAIE,OACbH,KAAKK,YAAcJ,IAAIE,OAExB,cAAe,QAAS,MAAO,cAAcG,SAAQ,SAAUC,UAC1DC,KAAOR,KAAKI,cAAgBJ,KAAKI,aAAa,cAAgBG,MAC9DC,MAAQP,IAAIO,OACdR,KAAKS,aAAaF,KAAMN,IAAIO,oBAWzBE,KAAKC,KAAMV,aACdW,MAAQ,CAACD,MACNC,MAAMC,QAAQ,KACfC,GAAKF,MAAMG,SACK,IAAhBD,GAAGZ,SAAgB,IACjBY,GAAGE,cAAgBF,GAAGE,aAAa,8BAGvCjB,cAAce,GAAIb,aACdgB,SAAWH,GAAGG,UAAY,GACrBC,EAAI,EAAGA,EAAID,SAASJ,OAAQK,IACnCN,MAAMO,KAAKF,SAASC,eAWnBE,IAAInB,SAETS,KAAKW,SAASC,KAAMrB,KAAO,IAClB,IAAIsB,kBAAiB,SAAUC,MACtCA,KAAKlB,SAAQ,SAAUmB,IACpBA,EAAEC,YAAc,IAAIpB,SAAQ,SAAUqB,GAClB,IAAfA,EAAEzB,UACJQ,KAAKiB,EAAG1B,KAAO,aAKpB2B,QAAQP,SAASC,KAAM,CAAEO,WAAW,EAAMC,SAAS,YAEtDT,SAASU,gBAAgBC,UAAUC,OAAO,wBA0DvC,CACLb,IAAKA,IACLc,cAnDYC,QACZd,SAASU,gBAAgBC,UAAUI,IAAI,qBACnCC,EAAI,SAAWF,OAAOG,KAAO,IAAMH,OAAOI,QAE9CC,OAAOC,UAAY,CAAEH,KAAMH,OAAOG,KAAMrC,IAAK,YAGvCyC,OAASC,aAAaC,QAAQP,MAC9BK,OAAQ,KACNG,OAASC,KAAKC,MAAML,QACxBF,OAAOC,UAAUxC,IAAM4C,OACvBzB,IAAIyB,QAGNG,MAAMb,OAAOc,UAAW,CAAEC,YAAa,gBACpCC,MAAK,SAAUC,UACPA,EAAEC,UAEVF,MAAK,SAAUN,YAEZF,aAAaW,QAAQjB,EAAGS,KAAKS,UAAUV,SACvC,MAAOW,IAGJd,SACHF,OAAOC,UAAUxC,IAAM4C,OACvBzB,IAAIyB,YAGPY,OAAM,WACAf,QACHtB,IAAI,OAGV,MAAOoC,GACPR,MAAMb,OAAOc,WACVE,MAAK,SAAUC,UACPA,EAAEC,UAEVF,MAAK,SAAUN,QACdL,OAAOC,UAAUxC,IAAM4C,OACvBzB,IAAIyB,WAELY,OAAM,WACLrC,IAAI"}