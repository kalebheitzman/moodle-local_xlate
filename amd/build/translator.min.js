define("local_xlate/translator",["core/ajax"],(function(Ajax){var ATTRIBUTE_TYPES=["placeholder","title","alt","aria-label"],autoDetectEnabled=!0,detectedStrings=new Set,processedElements=new WeakSet,lastProcessTime=0;function normalizeTextForKey(text){if(!text)return"";var normalised=text;try{normalised.normalize&&(normalised=normalised.normalize("NFKC"))}catch(err){}normalised=normalised.toLowerCase().replace(/[\u200B-\u200D\uFEFF]/g,"");try{normalised=normalised.replace(/[^\p{L}\p{N}]+/gu," ")}catch(err){normalised=normalised.replace(/[^0-9a-zA-Z]+/g," ")}return normalised=normalised.replace(/\s+/g," ").trim()}function computeHash(normalised){if(!normalised)return"";var base;try{base=btoa(unescape(encodeURIComponent(normalised)))}catch(err){for(var charcodes=[],i=0;i<normalised.length;i++)charcodes.push(normalised.charCodeAt(i).toString(16));base=charcodes.join("")}return(base=(base=base.replace(/[^A-Za-z0-9]/g,"")).length<8?(base+"XXXXXXXX").substring(0,8):base.substring(0,8)).toUpperCase()}function setKeyAttribute(element,type,key){if(element&&key){var attrType="text"===type?"content":type;element.setAttribute("data-xlate-key-"+attrType,key)}}function getKeyFromAttributes(element,type){if(!element)return null;var attrType="text"===type?"content":type;return element.getAttribute("data-xlate-key-"+attrType)||element.getAttribute("data-xlate-"+attrType)}function translateNode(node,map){if(node&&1===node.nodeType){var key=getKeyFromAttributes(node,"text");if(key&&map[key])node.textContent=map[key],setKeyAttribute(node,"text",key);else if(1===node.childNodes.length&&3===node.childNodes[0].nodeType){var normalized=normalizeTextForKey(node.textContent.trim());if(normalized&&window.__XLATE__&&window.__XLATE__.sourceMap){var translationKey=window.__XLATE__.sourceMap[normalized];translationKey&&map[translationKey]&&(setKeyAttribute(node,"text",translationKey),node.textContent=map[translationKey])}}ATTRIBUTE_TYPES.forEach((function(attr){var attrKey=getKeyFromAttributes(node,attr);if(attrKey&&map[attrKey])return node.setAttribute(attr,map[attrKey]),void setKeyAttribute(node,attr,attrKey);var value=node.getAttribute&&node.getAttribute(attr);if(value){var normalisedAttr=normalizeTextForKey(value);if(normalisedAttr&&window.__XLATE__&&window.__XLATE__.sourceMap){var attrTranslationKey=window.__XLATE__.sourceMap[normalisedAttr];attrTranslationKey&&map[attrTranslationKey]&&(node.setAttribute(attr,map[attrTranslationKey]),setKeyAttribute(node,attr,attrTranslationKey))}}}))}}function isTranslatableText(text){if(!text||text.length<3)return!1;var normalized=normalizeTextForKey(text);if(!normalized)return!1;if((normalized.match(/[a-zA-Z\p{L}]/gu)||[]).length<.5*normalized.length)return!1;return-1===["ok","id","url","api","css","js","html","php"].indexOf(normalized)}function collectContextClasses(element){if(!element)return"";var blacklist=["active","show","hide","hidden","collapsed","expanded","selected","current","focus","open","close","tooltip","dropdown","modal","d-flex","d-none","d-block","mt-1","mt-2","mt-3","mt-4","mt-5","mb-1","mb-2","mb-3","mb-4","mb-5","ml-1","ml-2","ml-3","ml-4","ml-5","mr-1","mr-2","mr-3","mr-4","mr-5","p-1","p-2","p-3","p-4","p-5","sr-only","visually-hidden"],classes=[];element.classList&&Array.prototype.slice.call(element.classList).forEach((function(cls){cls&&cls.length>2&&-1===blacklist.indexOf(cls)&&!/^[0-9]/.test(cls)&&-1===classes.indexOf(cls)&&classes.push(cls)}));return classes.join(",")}function collectDataAttributes(element){if(!element||!element.attributes)return"";for(var dataAttrs=[],i=0;i<element.attributes.length;i++){var attr=element.attributes[i];0===attr.name.indexOf("data-")&&attr.value&&0!==attr.name.indexOf("data-xlate")&&dataAttrs.push(attr.value)}return dataAttrs.join(",")}function generateKey(element,text,type){if(!element||!text)return"";var parts=[],parent=element.parentElement;if(parent&&parent.tagName){parts.push(parent.tagName.toLowerCase());var parentClasses=collectContextClasses(parent);parentClasses&&parts.push(parentClasses);var parentData=collectDataAttributes(parent);parentData&&parts.push(parentData)}var tagName=element.tagName?element.tagName.toLowerCase():"";tagName&&parts.push(tagName);var classes=collectContextClasses(element);classes&&parts.push(classes);var dataAttrs=collectDataAttributes(element);return dataAttrs&&parts.push(dataAttrs),type&&"text"!==type&&parts.push(type),parts.push(text),function(str){for(var hash=0,i=0;i<str.length;i++)hash=(hash<<5)-hash+str.charCodeAt(i),hash&=hash;var hashStr=Math.abs(hash).toString(36);return hashStr.length<12?(hashStr+"000000000000").substring(0,12):hashStr.substring(0,12)}(parts.join("."))}function autoDetectString(element,text,type){if(autoDetectEnabled&&text){var fingerprint=function(text){var normalised=normalizeTextForKey(text);if(!normalised)return{slug:"",hash:"",normalized:""};for(var value,words=normalised.split(" "),slugParts=[],i=0;i<words.length&&slugParts.length<4;i++)0!==words[i].length&&slugParts.push((value=words[i])?value.split(/[\s_\-]+/).filter((function(part){return part.length>0})).map((function(part){return part.charAt(0).toUpperCase()+part.slice(1).toLowerCase()})).join(""):"");var slug=slugParts.join("");return slug||(slug="Text"),slug.length>48&&(slug=slug.substring(0,48)),{slug:slug,hash:computeHash(normalised),normalized:normalised}}(text);if(fingerprint.normalized){var component=function(element){if(!element)return"core";var container=element.closest("[data-region]");if(container){var region=container.getAttribute("data-region");if(region)return"region_"+region}if(container=element.closest(".block")){var blockClass=container.className.match(/block_(\w+)/);if(blockClass)return"block_"+blockClass[1]}if(container=element.closest(".activity")){var activityClass=container.className.match(/modtype_(\w+)/);if(activityClass)return"mod_"+activityClass[1]}return document.body.classList.contains("path-admin")?"admin":"core"}(element),dedupeKey=component+":"+fingerprint.normalized+":"+type;if(!detectedStrings.has(dedupeKey)){detectedStrings.add(dedupeKey);var key=generateKey(element,text,type);key&&Ajax.call([{methodname:"local_xlate_save_key",args:{component:component,key:key,source:text,lang:window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en",translation:text}}])[0].then((function(){return setKeyAttribute(element,type,key),window.__XLATE__&&(window.__XLATE__.map||(window.__XLATE__.map={}),window.__XLATE__.sourceMap||(window.__XLATE__.sourceMap={}),window.__XLATE__.map[key]=text,window.__XLATE__.sourceMap[fingerprint.normalized]=key),!0})).catch((function(){detectedStrings.delete(dedupeKey)}))}}}}function autoDetectElement(element){if(autoDetectEnabled&&element&&(!function(element){if(!element||!element.tagName)return!0;var tagName=element.tagName.toLowerCase();if(-1!==["script","style","meta","link","noscript","head"].indexOf(tagName))return!0;if(element.hasAttribute("data-xlate-ignore")||element.closest("[data-xlate-ignore]"))return!0;if(element.hasAttribute("data-xlate-key-content")||element.hasAttribute("data-xlate-content"))return!0;for(var i=0;i<ATTRIBUTE_TYPES.length;i++)if(element.hasAttribute("data-xlate-key-"+ATTRIBUTE_TYPES[i])||element.hasAttribute("data-xlate-"+ATTRIBUTE_TYPES[i]))return!0;for(var currentPath=window.location.pathname||"",adminPaths=["/admin/","/local/xlate/","/course/modedit.php","/grade/edit/","/backup/","/restore/","/user/editadvanced.php"],p=0;p<adminPaths.length;p++)if(0===currentPath.indexOf(adminPaths[p]))return!0;for(var adminSelectors=[".navbar",".navigation",".breadcrumb",".nav",".admin-menu",".settings-menu",".user-menu",".page-header-headings",".page-context-header",".activity-navigation",".course-content-header",".block_settings",".block_navigation","#page-navbar","#nav-drawer",".drawer",".form-autocomplete-suggestions",".popover",".tooltip",".dropdown-menu"],iSel=0;iSel<adminSelectors.length;iSel++)if(element.closest(adminSelectors[iSel]))return!0;for(var adminClasses=["editing","editor","admin-only","teacher-only","form-control","btn-secondary","btn-outline","text-muted","small","sr-only","accesshide"],elementClasses=(element.className||"").split(" "),j=0;j<adminClasses.length;j++)if(-1!==elementClasses.indexOf(adminClasses[j]))return!0;var text=element.textContent?element.textContent.trim():"";return text.length<3||-1!==["edit","delete","save","cancel","ok","yes","no","settings","config","admin","manage","update","hide","show","move","copy","options","actions"].indexOf(text.toLowerCase())}(element)&&(window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en")===(window.__XLATE__&&window.__XLATE__.siteLang||"en")&&!processedElements.has(element))){processedElements.add(element);var textContent=function(element){if(!element)return"";if(0===element.children.length)return element.textContent.trim();for(var simpleFormatting=!0,children=element.children,i=0;i<children.length;i++){var tagName=children[i].tagName.toLowerCase();if(-1===["b","i","em","strong","span","small"].indexOf(tagName)){simpleFormatting=!1;break}}return simpleFormatting?element.textContent.trim():""}(element);textContent&&isTranslatableText(textContent)&&autoDetectString(element,textContent,"text"),ATTRIBUTE_TYPES.forEach((function(attr){if(element.hasAttribute(attr)){var value=element.getAttribute(attr).trim();value&&isTranslatableText(value)&&autoDetectString(element,value,attr)}}))}}function walk(root,map){if(root)for(var stack=[root];stack.length;){var el=stack.pop();if(1===el.nodeType){if(el.hasAttribute&&el.hasAttribute("data-xlate-ignore"))continue;translateNode(el,map),autoDetectEnabled&&autoDetectElement(el);for(var children=el.children||[],i=0;i<children.length;i++)stack.push(children[i])}}}function run(map){try{walk(document.body,map||{}),autoDetectEnabled&&(setTimeout((function(){walk(document.body,map||{})}),1e3),setTimeout((function(){walk(document.body,map||{})}),3e3)),new MutationObserver((function(muts){muts.forEach((function(mutation){Array.prototype.slice.call(mutation.addedNodes||[]).forEach((function(node){1===node.nodeType&&(walk(node,map||{}),node.querySelectorAll&&Array.prototype.forEach.call(node.querySelectorAll("*"),(function(child){walk(child,map||{})})))}))}))})).observe(document.body,{childList:!0,subtree:!0}),"function"==typeof window.addEventListener&&(document.addEventListener("DOMContentLoaded",(function(){setTimeout((function(){walk(document.body,map||{})}),2e3)})),["focus","click","scroll"].forEach((function(eventType){document.addEventListener(eventType,(function(){var now=Date.now();now-lastProcessTime>250&&(lastProcessTime=now,setTimeout((function(){walk(document.body,map||{})}),100))}),!0)})))}finally{document.documentElement.classList.remove("xlate-loading")}}function setAutoDetect(enabled){autoDetectEnabled=!!enabled}return{run:run,init:function(config){document.documentElement.classList.add("xlate-loading"),void 0!==config.autodetect&&setAutoDetect(!(!1===config.autodetect||"false"===config.autodetect));var k="xlate:"+config.lang+":"+config.version;function processBundle(bundleData,cached){bundleData&&(bundleData.translations?(window.__XLATE__.map=bundleData.translations,window.__XLATE__.sourceMap=bundleData.sourceMap||{},cached||run(bundleData.translations)):(window.__XLATE__.map=bundleData,window.__XLATE__.sourceMap=bundleData.sourceMap||{},cached||run(bundleData)))}window.__XLATE__={lang:config.lang,siteLang:config.siteLang,map:{},sourceMap:{}};try{var cached=localStorage.getItem(k);cached&&processBundle(JSON.parse(cached),!0),fetch(config.bundleurl,{credentials:"same-origin"}).then((function(response){return response.json()})).then((function(bundleData){try{localStorage.setItem(k,JSON.stringify(bundleData))}catch(err){}return processBundle(bundleData,!1),!0})).catch((function(){cached||run({})}))}catch(err){fetch(config.bundleurl).then((function(response){return response.json()})).then((function(bundle){return processBundle(bundle,!1),!0})).catch((function(){run({})}))}},setAutoDetect:setAutoDetect}}));

//# sourceMappingURL=translator.min.js.map