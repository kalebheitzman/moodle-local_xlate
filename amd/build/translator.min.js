define("local_xlate/translator",["core/ajax"],(function(Ajax){var ATTRIBUTE_TYPES=["placeholder","title","alt","aria-label"],detectedStrings=new Set,processedElements=new WeakSet,lastProcessTime=0,pendingTranslationKeys=new Set,requestedTranslationKeys=new Set,missingFetchTimer=null,indicatorStylesAdded=!1,toggleButton=null,Translator={};function xlateDebug(){"undefined"!=typeof window&&window.XLATE_DEBUG&&("undefined"!=typeof console&&"function"==typeof console.debug?console.debug.apply(console,arguments):"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments))}function collectContextClasses(element){if(!element||!element.classList)return"";var blacklist=["active","show","hide","hidden","collapsed","expanded","d-flex","d-none","d-block","sr-only","visually-hidden"],classes=[];return Array.prototype.forEach.call(element.classList,(function(cls){cls&&cls.length>2&&-1===blacklist.indexOf(cls)&&!/^[0-9]/.test(cls)&&!/^[mp][tblr]?-[0-5]$/.test(cls)&&classes.push(cls)})),classes.join(",")}function collectDataAttributes(element){if(!element||!element.attributes)return"";for(var dataAttrs=[],i=0;i<element.attributes.length;i++){var attr=element.attributes[i];0===attr.name.indexOf("data-")&&0!==attr.name.indexOf("data-xlate")&&attr.value&&dataAttrs.push(attr.value)}return dataAttrs.join(",")}function simpleHash(str){for(var h1=2166136261,h2=2654435761,i=0;i<str.length;i++){var c=str.charCodeAt(i);h1^=c,h1=Math.imul(h1,16777619);var k=(h2=h2+c>>>0)^h2>>>16;k=(h2=Math.imul(k,2246822507))^h2>>>13,h2=((h2=Math.imul(k,3266489909))^h2>>>16)>>>0}var s=(h1>>>0).toString(36)+(h2>>>0).toString(36);return s.length<12?s=(s+"qwertyuiopasdfghjklz").substring(0,12):s.length>12&&(s=s.substring(0,12)),s}function isTranslatableText(text){if(!text||text.length<3)return!1;if((text.match(/[a-zA-Z]/g)||[]).length<.3*text.length)return!1;return-1===["ok","id","url","api"].indexOf(text.toLowerCase())}function hasTranslation(map,key){return!(!map||!Object.prototype.hasOwnProperty.call(map,key))}function shouldShowTranslations(){return!window.__XLATE__||!1!==window.__XLATE__.showTranslations}function toggleAutoIndicator(element,key,show){if(element&&"object"==typeof element){if(!show)return element.__xlateIndicator&&element.__xlateIndicator.remove&&element.__xlateIndicator.remove(),void(element.__xlateIndicator=null);if(!element.__xlateIndicator){ensureIndicatorStyles();var indicator=document.createElement("span");indicator.className="xlate-auto-indicator icon fa fa-globe text-muted",indicator.setAttribute("role","img"),indicator.setAttribute("aria-label","AI translated"),indicator.setAttribute("title","AI translated"),indicator.setAttribute("data-xlate-indicator",key||""),"function"==typeof element.appendChild&&element.appendChild(indicator),element.__xlateIndicator=indicator}}}function ensureIndicatorStyles(){if(!indicatorStylesAdded){indicatorStylesAdded=!0;var style=document.createElement("style");style.setAttribute("data-xlate-style","indicator"),style.textContent=".xlate-auto-indicator {  display:inline-flex;  align-items:center;  font-size:0.75em;  margin-left:0.35em;  opacity:0.75;}.xlate-auto-toggle {  position:fixed;  right:1rem;  bottom:1rem;  z-index:1040;}.xlate-auto-toggle .icon {  margin-right:0.35em;}",document.head.appendChild(style)}}function updateToggleButtonLabel(){if(toggleButton){var enabled=shouldShowTranslations(),label=enabled?"Hide AI translations":"Show AI translations";toggleButton.innerHTML='<span class="icon fa fa-language" aria-hidden="true"></span>'+label,toggleButton.setAttribute("aria-pressed",enabled?"true":"false"),toggleButton.setAttribute("title",label)}}function handleToggleClick(e){e&&e.preventDefault(),window.__XLATE__&&(window.__XLATE__.showTranslations=!shouldShowTranslations(),updateToggleButtonLabel(),processedElements=new WeakSet,walk(document.body,window.__XLATE__.map||{},!1))}function ensureToggleControl(){window.__XLATE__&&!window.__XLATE__.isCapture&&(ensureIndicatorStyles(),toggleButton||((toggleButton=document.createElement("button")).type="button",toggleButton.className="btn btn-light btn-sm xlate-auto-toggle",toggleButton.addEventListener("click",handleToggleClick),document.body.appendChild(toggleButton),updateToggleButtonLabel()))}function generateKey(element,text,type){if(!element||!text)return"";var parts=[],parent=element.parentElement;if(parent&&parent.tagName){parts.push(parent.tagName.toLowerCase());var parentClasses=collectContextClasses(parent);parentClasses&&parts.push(parentClasses);var parentData=collectDataAttributes(parent);parentData&&parts.push(parentData)}element.tagName&&parts.push(element.tagName.toLowerCase());var classes=collectContextClasses(element);classes&&parts.push(classes);var dataAttrs=collectDataAttributes(element);dataAttrs&&parts.push(dataAttrs),type&&"text"!==type&&parts.push(type);for(var directText="",i=0;i<element.childNodes.length;i++){var node=element.childNodes[i];3===node.nodeType&&(directText+=node.textContent)}return directText=directText.trim(),parts.push(directText),simpleHash(parts.join("."))}function setKeyAttribute(element,type,key){if(element&&key){var attrType="text"===type?"content":type;element.setAttribute("data-xlate-key-"+attrType,key)}}function getKeyFromAttributes(element,type){if(!element)return null;var attrType="text"===type?"content":type;return element.getAttribute("data-xlate-key-"+attrType)}function translateElement(element,type,map){var key=getKeyFromAttributes(element,type);if(key){if(function(element,type){if(element){var dataAttr="data-xlate-original-"+("text"===type?"content":type);if(!element.hasAttribute(dataAttr)){var original="";original="text"===type?function(element){if(!element)return"";for(var directText="",i=0;i<element.childNodes.length;i++){var node=element.childNodes[i];3===node.nodeType&&(directText+=node.textContent)}return directText}(element):element.getAttribute(type)||"",element.setAttribute(dataAttr,original)}}}(element,type),!shouldShowTranslations())return function(element,type){if(element){var dataAttr="data-xlate-original-"+("text"===type?"content":type);if(element.hasAttribute(dataAttr)){var original=element.getAttribute(dataAttr)||"";"text"===type?element.textContent=original:element.setAttribute(type,original)}}}(element,type),void("text"===type&&toggleAutoIndicator(element,key,!1));if(map&&hasTranslation(map,key)){var value=map[key];"string"==typeof value&&("text"===type?(element.textContent=value,toggleAutoIndicator(element,key,!function(key){if(!window.__XLATE__||!window.__XLATE__.reviewMap)return!0;var flag=window.__XLATE__.reviewMap[key];return 1===flag||"1"===flag||!0===flag}(key))):element.setAttribute(type,value))}else"text"===type&&toggleAutoIndicator(element,key,!1)}}function detectComponent(element){if(!element)return"core";var container=element.closest("[data-region]");if(container){var region=container.getAttribute("data-region");if(region)return"region_"+region}if(container=element.closest(".block")){var blockClass=container.className.match(/block_(\w+)/);if(blockClass)return"block_"+blockClass[1]}return document.body.classList.contains("path-admin")?"admin":"core"}function saveToDatabase(element,text,type,key,existingMap){if(existingMap&&existingMap[key])xlateDebug("[XLATE] Skipping save - key exists:",key);else{var component=detectComponent(element),dedupeKey=component+":"+key+":"+type;if(!detectedStrings.has(dedupeKey)){detectedStrings.add(dedupeKey),xlateDebug("[XLATE] Saving new key:",key,"component:",component,"text:",text.substring(0,50));var pageCourseId=0;"undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?pageCourseId=window.XLATE_COURSEID:"undefined"!=typeof M&&M.cfg&&M.cfg.courseid&&(pageCourseId=M.cfg.courseid);var curLang=window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en",reviewedFlag=curLang===(window.__XLATE__&&window.__XLATE__.siteLang||"en")?1:0;Ajax.call([{methodname:"local_xlate_save_key",args:{component:component,key:key,source:text,lang:curLang,translation:text,reviewed:reviewedFlag,courseid:pageCourseId,context:component}}])[0].then((function(){return window.__XLATE__&&(window.__XLATE__.map||(window.__XLATE__.map={}),window.__XLATE__.map[key]=text,window.__XLATE__.reviewMap||(window.__XLATE__.reviewMap={}),window.__XLATE__.reviewMap[key]=1),!0})).catch((function(){detectedStrings.delete(dedupeKey)}))}}}function shouldIgnoreElement(element){if(!element||!element.tagName)return!0;var tagName=element.tagName.toLowerCase();if(-1!==["script","style","meta","link","noscript","head"].indexOf(tagName))return!0;if(window.XLATE_EXCLUDE_SELECTORS&&Array.isArray(window.XLATE_EXCLUDE_SELECTORS))for(var i=0;i<window.XLATE_EXCLUDE_SELECTORS.length;i++){var sel=window.XLATE_EXCLUDE_SELECTORS[i];if(sel)try{if(element.matches(sel)||element.closest&&element.closest(sel))return!0}catch(e){xlateDebug("[XLATE][DEBUG] Invalid selector:",sel,e)}}if(element.hasAttribute("data-xlate-ignore")||element.closest("[data-xlate-ignore]"))return!0;for(var currentPath=window.location.pathname||"",adminPaths=["/admin/","/local/xlate/","/course/modedit.php"],p=0;p<adminPaths.length;p++)if(0===currentPath.indexOf(adminPaths[p]))return!0;return!1}function collectKeysFromElement(el,keySet){var attrs=el&&el.attributes;if(attrs)for(var j=0;j<attrs.length;j++){var a=attrs[j],name=a&&a.name;if(name&&0===name.indexOf("data-xlate-key-")){var val=a.value;val&&(keySet[val]=!0)}}}function processCandidateValue(element,value,attrName,tagOnly,isCapture,map){if(value&&isTranslatableText(value)){var key=generateKey(element,value,attrName);key&&(setKeyAttribute(element,attrName,key),tagOnly||(isCapture?saveToDatabase(element,value,attrName,key,map):map&&(hasTranslation(map,key)?translateElement(element,attrName,map):function(key){if(!key||pendingTranslationKeys.has(key)||requestedTranslationKeys.has(key))return;if(!window.__XLATE__||window.__XLATE__.isCapture)return;pendingTranslationKeys.add(key),function(){if(null!==missingFetchTimer)return;missingFetchTimer=window.setTimeout((function(){if(missingFetchTimer=null,pendingTranslationKeys&&0!==pendingTranslationKeys.size){var keys=[];pendingTranslationKeys.forEach((function(k){keys.push(k)})),pendingTranslationKeys.clear(),function(keys){if(!keys||!keys.length)return;if(!window.__XLATE__||window.__XLATE__.isCapture)return;var bundleUrl=window.__XLATE__.bundleUrl||"";if(!bundleUrl)return;fetch(bundleUrl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keys})}).then((function(response){return response.json()})).then((function(data){var map=window.__XLATE__.map||{},translations=data&&data.translations?data.translations:data;if(!translations||"object"!=typeof translations)return markKeysAsRequested(keys),null;var updated=function(map,translations){var updated=!1;return Object.keys(translations).forEach((function(k){var value=translations[k];Object.prototype.hasOwnProperty.call(map,k)&&map[k]===value||(map[k]=value,updated=!0)})),updated}(map,translations),reviewChanged=function(reviewUpdates){if(!reviewUpdates||"object"!=typeof reviewUpdates)return!1;window.__XLATE__.reviewMap||(window.__XLATE__.reviewMap={});var reviewChanged=!1;return Object.keys(reviewUpdates).forEach((function(k){var incoming=reviewUpdates[k];window.__XLATE__.reviewMap[k]!==incoming&&(reviewChanged=!0),window.__XLATE__.reviewMap[k]=incoming})),reviewChanged}(data&&data.reviewed?data.reviewed:null);return(updated||reviewChanged)&&(window.__XLATE__.map=map,function(translations){if(!window.__XLATE__.cacheKey)return;try{var cachedTranslations,cachedReviewed,cached=localStorage.getItem(window.__XLATE__.cacheKey),cachedPayload=cached?JSON.parse(cached):null;cachedPayload&&"object"==typeof cachedPayload&&cachedPayload.translations?(cachedTranslations=cachedPayload.translations,cachedReviewed=cachedPayload.reviewed||{}):cachedPayload&&"object"==typeof cachedPayload&&!Array.isArray(cachedPayload)?(cachedTranslations=cachedPayload,cachedReviewed={}):(cachedTranslations={},cachedReviewed={}),Object.keys(translations).forEach((function(k){cachedTranslations[k]=translations[k]}));var reviewMap=window.__XLATE__.reviewMap||{};Object.keys(reviewMap).forEach((function(k){cachedReviewed[k]=reviewMap[k]})),localStorage.setItem(window.__XLATE__.cacheKey,JSON.stringify({translations:cachedTranslations,reviewed:cachedReviewed}))}catch(e){}}(translations),processedElements=new WeakSet,walk(document.body,map,!1)),markKeysAsRequested(keys),null})).catch((function(err){return function(keys){keys.forEach((function(k){requestedTranslationKeys.delete(k)}))}(keys),xlateDebug("[XLATE] Missing translation fetch failed",err),null}))}(keys)}}),200)}()}(key))))}}function processElement(element,map,tagOnly){if(!shouldIgnoreElement(element)&&!processedElements.has(element)){processedElements.add(element);for(var isCapture=(window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en")===(window.__XLATE__&&window.__XLATE__.siteLang||"en"),directText="",i=0;i<element.childNodes.length;i++){var node=element.childNodes[i];3===node.nodeType&&(directText+=node.textContent)}directText=directText.trim(),processCandidateValue(element,directText,"text",tagOnly,isCapture,map),ATTRIBUTE_TYPES.forEach((function(attr){if(element.hasAttribute(attr)){var value=element.getAttribute(attr).trim();processCandidateValue(element,value,attr,tagOnly,isCapture,map)}}))}}function markKeysAsRequested(keys){keys.forEach((function(k){requestedTranslationKeys.add(k)}))}function walk(root,map,tagOnly){if(root){var captureSelectors=window.XLATE_CAPTURE_SELECTORS&&Array.isArray(window.XLATE_CAPTURE_SELECTORS)&&window.XLATE_CAPTURE_SELECTORS.length?window.XLATE_CAPTURE_SELECTORS:null,roots=[];captureSelectors?(captureSelectors.forEach((function(sel){try{for(var found=document.querySelectorAll(sel),i=0;i<found.length;i++)roots.push(found[i])}catch(e){}})),roots.length||(roots=[root])):roots=[root],roots.forEach((function(scanRoot){for(var stack=[scanRoot];stack.length;){var el=stack.pop();if(1===el.nodeType){if(shouldIgnoreElement(el))continue;processElement(el,map,tagOnly);for(var children=el.children||[],i=0;i<children.length;i++)stack.push(children[i])}}}))}}function run(map){try{walk(document.body,map||{}),window.__XLATE__&&!window.__XLATE__.isCapture&&ensureToggleControl(),setTimeout((function(){walk(document.body,map||{}),window.__XLATE__&&!window.__XLATE__.isCapture&&ensureToggleControl()}),1e3),setTimeout((function(){walk(document.body,map||{}),window.__XLATE__&&!window.__XLATE__.isCapture&&ensureToggleControl()}),3e3),setTimeout((function(){walk(document.body,map||{}),window.__XLATE__&&!window.__XLATE__.isCapture&&ensureToggleControl()}),6e3),new MutationObserver((function(muts){muts.forEach((function(mutation){Array.prototype.slice.call(mutation.addedNodes||[]).forEach((function(node){1===node.nodeType&&walk(node,map||{})}))}))})).observe(document.body,{childList:!0,subtree:!0}),"function"==typeof window.addEventListener&&["focus","click","scroll"].forEach((function(eventType){document.addEventListener(eventType,(function(){var now=Date.now();now-lastProcessTime>250&&(lastProcessTime=now,setTimeout((function(){walk(document.body,map||{}),window.__XLATE__&&!window.__XLATE__.isCapture&&ensureToggleControl()}),100))}),!0)}))}finally{document.documentElement.classList.remove("xlate-loading")}}function getSourceForElementAttr(el,typename){if(!el)return"";if("content"===typename){for(var dt="",dn=0;dn<el.childNodes.length;dn++){var node=el.childNodes[dn];3===node.nodeType&&(dt+=node.textContent)}return dt.trim()}try{return el.getAttribute(typename)||""}catch(e){return""}}function initCaptureMode(config,courseId){xlateDebug("[XLATE] Capture mode - starting tag-only pass"),processedElements=new WeakSet,walk(document.body,{},!0);var collected=function(root){for(var keySet={},keyDetails={},all=root&&root.querySelectorAll?root.querySelectorAll("*"):[],i=0;i<all.length;i++){var el=all[i];collectKeysFromElement(el,keySet);var attrs=el&&el.attributes;if(attrs)for(var j=0;j<attrs.length;j++){var attrname=attrs[j]&&attrs[j].name;if(attrname&&0===attrname.indexOf("data-xlate-key-")){var aval=attrs[j].value;if(aval&&!keyDetails[aval]){var src=getSourceForElementAttr(el,attrname.substring("data-xlate-key-".length));keyDetails[aval]={component:detectComponent(el),source:src}}}}}return{keySet:keySet,keyDetails:keyDetails}}(document),keySetCap=collected.keySet,keyDetails=collected.keyDetails,keysCap=Object.keys(keySetCap);if(xlateDebug("[XLATE] Collected",keysCap.length,"keys from DOM"),!keysCap.length)return xlateDebug("[XLATE] No keys found, skipping bundle fetch"),void run({});xlateDebug("[XLATE] Fetching bundle to check existing keys..."),fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keysCap})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map,sourceMap=map&&map.sourceMap?map.sourceMap:{},reviewMap=map&&map.reviewed&&"object"==typeof map.reviewed?map.reviewed:{},associations=map&&map.associations?map.associations:{};return translations&&"object"==typeof translations||(translations={}),window.__XLATE__.map=translations,window.__XLATE__.sourceMap=sourceMap,window.__XLATE__.reviewMap=reviewMap,xlateDebug("[XLATE] Bundle returned",Object.keys(translations).length,"existing translations"),function(keys,keyDetails,associations,courseId){if(courseId&&associations&&"object"==typeof associations){for(var toAssociate=[],ti=0;ti<keys.length;ti++){var key=keys[ti];if(!associations[key]){var detail=keyDetails[key]||null;detail&&toAssociate.push({component:detail.component,key:key,source:detail.source||""})}}if(toAssociate.length){xlateDebug("[XLATE] Associating",toAssociate.length,"keys with course",courseId);try{Ajax.call([{methodname:"local_xlate_associate_keys",args:{keys:toAssociate,courseid:courseId,context:""}}])}catch(e){xlateDebug("[XLATE] Bulk-associate exception",e)}}}}(keysCap,keyDetails,associations,courseId),processedElements=new WeakSet,walk(document.body,translations,!1),run(translations),!0})).catch((function(err){xlateDebug("[XLATE] Bundle fetch failed:",err),processedElements=new WeakSet,walk(document.body,{},!1),run({})}))}function initTranslationMode(config){xlateDebug("[XLATE] Translation mode - starting tag-only pass");try{processedElements=new WeakSet,walk(document.body,{},!0);for(var keySet={},all=document.querySelectorAll("*"),i=0;i<all.length;i++)collectKeysFromElement(all[i],keySet);var keys=Object.keys(keySet);if(!keys.length)return void run({});var cacheKey="xlate:"+config.lang+":"+config.version+":keys:"+keys.length;window.__XLATE__.cacheKey=cacheKey;var cachedPayload=function(cacheKey){if(!cacheKey)return null;try{var cached=localStorage.getItem(cacheKey);if(!cached)return null;var payload=JSON.parse(cached);if(!payload||"object"!=typeof payload)return null;if(payload.translations&&"object"==typeof payload.translations)return{translations:payload.translations,reviewed:payload.reviewed||{}};if(!Array.isArray(payload))return{translations:payload,reviewed:{}}}catch(e){return null}return null}(cacheKey);cachedPayload&&(window.__XLATE__.map=cachedPayload.translations,window.__XLATE__.reviewMap=cachedPayload.reviewed,processedElements=new WeakSet,run(cachedPayload.translations)),fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keys})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map,reviewMap=map&&map.reviewed&&"object"==typeof map.reviewed?map.reviewed:{};translations&&"object"==typeof translations||(translations={});try{localStorage.setItem(cacheKey,JSON.stringify({translations:translations,reviewed:reviewMap}))}catch(e){}return window.__XLATE__.map=translations,window.__XLATE__.reviewMap=reviewMap,processedElements=new WeakSet,run(translations),!0})).catch((function(){run({})}))}catch(err){run({})}}function init(config){if(document.documentElement.classList.add("xlate-loading"),config.isEditing)return xlateDebug("[XLATE] Edit mode detected (isEditing=true): skipping translation/capture logic."),void document.documentElement.classList.remove("xlate-loading");window.__XLATE__=function(config){var state={lang:config.lang,siteLang:config.siteLang,captureSourceLang:config.captureSourceLang||config.siteLang,map:{},sourceMap:{},reviewMap:{},bundleUrl:config.bundleurl||"",version:config.version||"",cacheKey:""};return state.isCapture=config.lang===state.captureSourceLang,state}(config);var courseId="undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?window.XLATE_COURSEID:"undefined"!=typeof M&&M.cfg&&M.cfg.courseid?M.cfg.courseid:null;xlateDebug("[XLATE] Initializing:",{currentLang:config.lang,siteLang:config.siteLang,captureSourceLang:config.captureSourceLang||config.siteLang,isCapture:window.__XLATE__.isCapture,courseId:courseId}),window.__XLATE__.isCapture?initCaptureMode(config,courseId):initTranslationMode(config)}return Translator.utils={},Translator.keys={},Translator.attrs={},Translator.capture={},Translator.dom={},Translator.api={},Translator.utils.collectContextClasses=collectContextClasses,Translator.utils.collectDataAttributes=collectDataAttributes,Translator.utils.isTranslatableText=isTranslatableText,Translator.utils.simpleHash=simpleHash,Translator.utils.hasTranslation=hasTranslation,Translator.keys.generateKey=generateKey,Translator.keys.generateKey=generateKey,Translator.attrs.setKeyAttribute=setKeyAttribute,Translator.attrs.setKeyAttribute=setKeyAttribute,Translator.attrs.getKeyFromAttributes=getKeyFromAttributes,Translator.attrs.getKeyFromAttributes=getKeyFromAttributes,Translator.capture.translateElement=translateElement,Translator.capture.translateElement=translateElement,Translator.capture.detectComponent=detectComponent,Translator.capture.detectComponent=detectComponent,Translator.capture.saveToDatabase=saveToDatabase,Translator.capture.saveToDatabase=saveToDatabase,Translator.dom.shouldIgnoreElement=shouldIgnoreElement,Translator.dom.collectKeysFromElement=collectKeysFromElement,Translator.dom.processElement=processElement,Translator.dom.walk=walk,Translator.dom.walk=walk,Translator.api.run=run,Translator.api.init=init,Translator.run=run,Translator.init=init,Translator}));

//# sourceMappingURL=translator.min.js.map