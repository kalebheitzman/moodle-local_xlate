define("local_xlate/translator",["core/ajax"],(function(Ajax){var ATTRIBUTE_TYPES=["placeholder","title","alt","aria-label"],KEYED_ATTRIBUTE_TYPES=["content"].concat(ATTRIBUTE_TYPES),detectedStrings=new Set,processedElements=new WeakSet,lastProcessTime=0,pendingTranslationKeys=new Set,requestedTranslationKeys=new Set,missingFetchTimer=null,indicatorStylesAdded=!1,BLOCK_CHILD_SELECTOR=["div","section","article","header","footer","main","aside","nav","figure","figcaption","h1","h2","h3","h4","h5","h6","ul","ol","li","p"].join(", ");"undefined"!=typeof window&&(void 0===window.XLATE_LAST_TOGGLE_REQUEST&&(window.XLATE_LAST_TOGGLE_REQUEST=null),void 0===window.XLATE_LAST_TOGGLE_APPLIED&&(window.XLATE_LAST_TOGGLE_APPLIED=null));var ALLOWED_INLINE_TAGS={a:["href","title","target","rel"],abbr:["title"],b:[],br:[],cite:[],code:[],em:[],i:[],kbd:[],mark:[],q:[],s:[],small:[],span:["class"],strong:[],sub:[],sup:[],u:[]},INLINE_PIGGYBACK_TAGS=["strong","b","em","i","u","mark"],Translator={};function sanitizeNode(root){root&&root.childNodes&&Array.prototype.slice.call(root.childNodes).forEach((function(child){if(1===child.nodeType){var tag=child.tagName.toLowerCase();return Object.prototype.hasOwnProperty.call(ALLOWED_INLINE_TAGS,tag)?(allowedAttrs=ALLOWED_INLINE_TAGS[tag],(element=child)&&element.attributes&&Array.prototype.slice.call(element.attributes).forEach((function(attr){var name=attr.name.toLowerCase();-1===allowedAttrs.indexOf(name)||!("href"!==name&&"src"!==name||function(url){if(!url)return!1;var trimmed=url.trim();if(!trimmed)return!1;if("#"===trimmed[0])return!0;var lower=trimmed.toLowerCase();return!/^(?:\s*(?:javascript|data)\s*:)/.test(lower)&&/^(https?:|mailto:|tel:)/.test(lower)}(attr.value||""))||"target"===name&&"_blank"!==attr.value?element.removeAttribute(attr.name):"target"===name&&"_blank"===attr.value&&element.setAttribute("rel","noopener noreferrer")})),void sanitizeNode(child)):(sanitizeNode(child),void function(element){if(element&&element.parentNode){for(var parent=element.parentNode;element.firstChild;)parent.insertBefore(element.firstChild,element);parent.removeChild(element)}}(child))}var element,allowedAttrs;3!==child.nodeType&&child.parentNode.removeChild(child)}))}function sanitizeTranslationHtml(value,targetTag){if(!value)return"";var container=document.createElement("div");if(container.innerHTML=value,sanitizeNode(container),targetTag&&1===container.childNodes.length){var firstChild=container.childNodes[0];if(1===firstChild.nodeType&&firstChild.tagName.toLowerCase()===targetTag&&firstChild.childNodes.length){for(var unwrap=document.createElement("div");firstChild.firstChild;)unwrap.appendChild(firstChild.firstChild);return unwrap.innerHTML}}return container.innerHTML}function getDirectChildText(element){if(!element||!element.childNodes)return"";for(var text="",i=0;i<element.childNodes.length;i++){var node=element.childNodes[i];3===node.nodeType&&(text+=node.textContent)}return text.trim()}function extractPlainText(value){if(!value)return"";if(-1===value.indexOf("<"))return value.trim();var container=document.createElement("div");return container.innerHTML=value,(container.textContent||container.innerText||"").trim()}function getElementSourcePayload(element){if(!element)return"";var raw=element.innerHTML||"",tag=element.tagName?element.tagName.toLowerCase():"";if(raw&&-1!==raw.indexOf("<")){var sanitized=sanitizeTranslationHtml(raw,tag).trim();if(sanitized)return sanitized;window.__XLATE__&&window.__XLATE__.isCapture&&xlateDebug("[XLATE][Capture] Sanitized HTML empty for",describeElementContext(element),"raw snippet:",abbreviateValue(raw));var fallbackPlain=extractPlainText(raw);if(fallbackPlain)return fallbackPlain}var direct=getDirectChildText(element);return direct||(element.textContent||"").trim()}function xlateDebug(){"undefined"!=typeof window&&window.XLATE_DEBUG&&("undefined"!=typeof console&&"function"==typeof console.debug?console.debug.apply(console,arguments):"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments))}function describeElementContext(element){if(!element||!element.tagName)return"<unknown>";var tag=element.tagName.toLowerCase(),id=element.id?"#"+element.id:"",classSuffix="";if(element.className&&"string"==typeof element.className){var classes=element.className.trim().split(/\s+/).filter(Boolean).slice(0,3);classes.length&&(classSuffix="."+classes.join("."))}return tag+id+classSuffix}function abbreviateValue(value){if(!value)return"";var trimmed=value.trim();return trimmed.length<=80?trimmed:trimmed.substring(0,77)+"..."}function collectContextClasses(element){if(!element||!element.classList)return"";var blacklist=["active","show","hide","hidden","collapsed","expanded","d-flex","d-none","d-block","sr-only","visually-hidden"],classes=[];return Array.prototype.forEach.call(element.classList,(function(cls){cls&&cls.length>2&&-1===blacklist.indexOf(cls)&&!/^[0-9]/.test(cls)&&!/^[mp][tblr]?-[0-5]$/.test(cls)&&classes.push(cls)})),classes.join(",")}function collectDataAttributes(element){if(!element||!element.attributes)return"";for(var dataAttrs=[],i=0;i<element.attributes.length;i++){var attr=element.attributes[i];0===attr.name.indexOf("data-")&&0!==attr.name.indexOf("data-xlate")&&attr.value&&dataAttrs.push(attr.value)}return dataAttrs.join(",")}function simpleHash(str){for(var h1=2166136261,h2=2654435761,i=0;i<str.length;i++){var c=str.charCodeAt(i);h1^=c,h1=Math.imul(h1,16777619);var k=(h2=h2+c>>>0)^h2>>>16;k=(h2=Math.imul(k,2246822507))^h2>>>13,h2=((h2=Math.imul(k,3266489909))^h2>>>16)>>>0}var s=(h1>>>0).toString(36)+(h2>>>0).toString(36);return s.length<12?s=(s+"qwertyuiopasdfghjklz").substring(0,12):s.length>12&&(s=s.substring(0,12)),s}function isTranslatableText(text){if(!text||text.length<3)return!1;if((text.match(/[a-zA-Z]/g)||[]).length<.3*text.length)return!1;return-1===["ok","id","url","api"].indexOf(text.toLowerCase())}function hasTranslation(map,key){return!(!map||!Object.prototype.hasOwnProperty.call(map,key))}function restoreOriginalValue(element,type){if(element){var dataAttr="data-xlate-original-"+("text"===type?"content":type);if(element.hasAttribute(dataAttr)){var original=element.getAttribute(dataAttr)||"";"text"===type?element.innerHTML=original:element.setAttribute(type,original)}}}function shouldShowTranslations(){return!window.__XLATE__||!1!==window.__XLATE__.showTranslations}function getSourceStringForKey(key){return key&&window.__XLATE__&&window.__XLATE__.sourceStrings&&Object.prototype.hasOwnProperty.call(window.__XLATE__.sourceStrings,key)?window.__XLATE__.sourceStrings[key]:null}function dispatchXlateEvent(name,detail){if("undefined"!=typeof document&&"function"==typeof document.dispatchEvent){var event,payload=detail||{};try{event=new CustomEvent(name,{detail:payload})}catch(err){(event=document.createEvent("CustomEvent")).initCustomEvent(name,!0,!0,payload)}document.dispatchEvent(event)}}function applyVisibilityState(newValue){window.__XLATE__.showTranslations=newValue,"undefined"!=typeof document&&document.documentElement&&document.documentElement.classList.toggle("xlate-original-visible",!newValue),processedElements=new WeakSet,function(map){if("undefined"==typeof document)return;var selector=KEYED_ATTRIBUTE_TYPES.map((function(attr){return"[data-xlate-key-"+attr+"]"})).join(",");document.querySelectorAll(selector).forEach((function(node){1===node.nodeType&&(node.hasAttribute("data-xlate-key-content")&&applyVisibilityForElement(node,"text",map),ATTRIBUTE_TYPES.forEach((function(attr){node.hasAttribute("data-xlate-key-"+attr)&&applyVisibilityForElement(node,attr,map)})))}))}(window.__XLATE__.map||{}),dispatchXlateEvent("xlate:visibilitychange",{visible:newValue})}function setTranslationVisibility(visible){var request,source,requestedVisibility="boolean"==typeof visible?visible:null;if(request={visible:requestedVisibility},source="direct_call","undefined"!=typeof window&&(window.XLATE_LAST_TOGGLE_REQUEST={time:Date.now(),request:request||{},source:source||"direct"}),"undefined"!=typeof window&&(window.XLATE_TOGGLE_LOG=window.XLATE_TOGGLE_LOG||[],window.XLATE_TOGGLE_LOG.push({at:Date.now(),requested:requestedVisibility,priorState:shouldShowTranslations()})),window.__XLATE__&&!window.__XLATE__.isCapture){var newValue="boolean"==typeof visible?visible:!shouldShowTranslations();if("undefined"!=typeof window&&(window.XLATE_LAST_TOGGLE_APPLIED=window.XLATE_LAST_TOGGLE_APPLIED||{},window.XLATE_LAST_TOGGLE_APPLIED.result=newValue),newValue)applyVisibilityState(newValue);else(function(keys){if(!window.__XLATE__)return Promise.resolve();var store=window.__XLATE__.sourceStrings||{};window.__XLATE__.sourceStrings=store;var missing=[];if(Array.isArray(keys)&&keys.forEach((function(key){key&&(Object.prototype.hasOwnProperty.call(store,key)&&""!==store[key]||missing.push(key))})),!missing.length)return Promise.resolve();if(window.__XLATE__.sourceFetchPromise)return window.__XLATE__.sourceFetchPromise;var sourceUrl,bundleUrl=window.__XLATE__.bundleUrl||window.__XLATE__.bundleurl||"";if(!bundleUrl)return Promise.resolve();try{sourceUrl=new URL(bundleUrl,window.location.origin)}catch(err){var anchor=document.createElement("a");anchor.href=bundleUrl,sourceUrl=new URL(anchor.href,window.location.origin)}var sourceLang=window.__XLATE__.captureSourceLang||window.__XLATE__.sourceLang||window.__XLATE__.lang;if(!sourceLang)return Promise.resolve();sourceUrl.searchParams.set("lang",sourceLang);var payload={keys:missing};return window.__XLATE__.sourceFetchPromise=fetch(sourceUrl.toString(),{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}).then((function(response){return response.json()})).then((function(map){var providedSources=map&&map.sources&&"object"==typeof map.sources?map.sources:{},translations=map&&map.translations&&"object"==typeof map.translations?map.translations:{};Object.keys(providedSources).forEach((function(key){store[key]=providedSources[key]})),Object.keys(translations).forEach((function(key){store[key]||(store[key]=translations[key])}))})).catch((function(err){xlateDebug("[XLATE] Source fetch failed",err)})).finally((function(){window.__XLATE__.sourceFetchPromise=null})),window.__XLATE__.sourceFetchPromise})(Object.keys(window.__XLATE__.map||{})).then((function(){applyVisibilityState(newValue)})).catch((function(){applyVisibilityState(newValue)}))}}function toggleAutoIndicator(element,key,show){if(element&&"object"==typeof element){if(!!(!window.__XLATE__||!window.__XLATE__.inlineIndicator)||!show)return element.__xlateIndicator&&element.__xlateIndicator.remove&&element.__xlateIndicator.remove(),void(element.__xlateIndicator=null);if(!element.__xlateIndicator){!function(){if(indicatorStylesAdded)return;indicatorStylesAdded=!0;var style=document.createElement("style");style.setAttribute("data-xlate-style","indicator"),style.textContent=".xlate-auto-indicator {  display:inline-flex;  align-items:center;  font-size:0.75em;  margin-left:0.35em;  opacity:0.75;}",document.head.appendChild(style)}();var indicator=document.createElement("span");indicator.className="xlate-auto-indicator icon fa fa-globe text-muted",indicator.setAttribute("role","img"),indicator.setAttribute("aria-label","AI translated"),indicator.setAttribute("title","AI translated"),indicator.setAttribute("data-xlate-indicator",key||""),"function"==typeof element.appendChild&&element.appendChild(indicator),element.__xlateIndicator=indicator}}}function generateKey(element,text,type){if(!element||!text)return"";var parts=[],parent=element.parentElement;if(parent&&parent.tagName){parts.push(parent.tagName.toLowerCase());var parentClasses=collectContextClasses(parent);parentClasses&&parts.push(parentClasses);var parentData=collectDataAttributes(parent);parentData&&parts.push(parentData)}element.tagName&&parts.push(element.tagName.toLowerCase());var classes=collectContextClasses(element);classes&&parts.push(classes);var dataAttrs=collectDataAttributes(element);dataAttrs&&parts.push(dataAttrs),type&&"text"!==type&&parts.push(type);var directText=getDirectChildText(element);return parts.push(directText),simpleHash(parts.join("."))}function setKeyAttribute(element,type,key){if(element&&key){var attrType="text"===type?"content":type;element.setAttribute("data-xlate-key-"+attrType,key)}}function getKeyFromAttributes(element,type){if(!element)return null;var attrType="text"===type?"content":type;return element.getAttribute("data-xlate-key-"+attrType)}function translateElement(element,type,map){var key=getKeyFromAttributes(element,type);if(key)if(function(element,type){if(element){var dataAttr="data-xlate-original-"+("text"===type?"content":type);if(!element.hasAttribute(dataAttr)){var original="";original="text"===type?element.innerHTML:element.getAttribute(type)||"",element.setAttribute(dataAttr,original)}}}(element,type),shouldShowTranslations())if(map&&hasTranslation(map,key)){var value=map[key];if("string"==typeof value)if("text"===type){var sanitized=sanitizeTranslationHtml(value,element.tagName?element.tagName.toLowerCase():"");element.innerHTML=sanitized,toggleAutoIndicator(element,key,!function(key){if(!window.__XLATE__||!window.__XLATE__.reviewMap)return!0;var flag=window.__XLATE__.reviewMap[key];return 1===flag||"1"===flag||!0===flag}(key))}else element.setAttribute(type,value)}else"text"===type&&toggleAutoIndicator(element,key,!1);else{var sourceValue=getSourceStringForKey(key);if("text"===type){if("string"==typeof sourceValue&&""!==sourceValue){var sanitizedSource=sanitizeTranslationHtml(sourceValue,element.tagName?element.tagName.toLowerCase():"");element.innerHTML=sanitizedSource}else restoreOriginalValue(element,type);toggleAutoIndicator(element,key,!1)}else"string"==typeof sourceValue&&""!==sourceValue?element.setAttribute(type,sourceValue):restoreOriginalValue(element,type)}}function renderOriginalElement(element,type,key){if(element&&key){var sourceValue=getSourceStringForKey(key);if("text"!==type)"string"==typeof sourceValue&&""!==sourceValue?element.setAttribute(type,sourceValue):restoreOriginalValue(element,type);else{if("string"==typeof sourceValue&&""!==sourceValue){var hostTag=element.tagName?element.tagName.toLowerCase():"";element.innerHTML=sanitizeTranslationHtml(sourceValue,hostTag)}else restoreOriginalValue(element,type);toggleAutoIndicator(element,key,!1)}}}function applyVisibilityForElement(element,type,map){if(element){var key=getKeyFromAttributes(element,type);key&&(shouldShowTranslations()?translateElement(element,type,map):renderOriginalElement(element,type,key))}}function detectComponent(element){if(!element)return"core";var container=element.closest("[data-region]");if(container){var region=container.getAttribute("data-region");if(region)return"region_"+region}if(container=element.closest(".block")){var blockClass=container.className.match(/block_(\w+)/);if(blockClass)return"block_"+blockClass[1]}return document.body.classList.contains("path-admin")?"admin":"core"}function saveToDatabase(element,text,type,key,existingMap){if(isTranslatableText(extractPlainText(text))){if(existingMap&&Object.prototype.hasOwnProperty.call(existingMap,key))if((existingMap[key]||"").trim()===text.trim())return void xlateDebug("[XLATE][Capture] Skip save - identical text already stored",key);var component=detectComponent(element),dedupeKey=component+":"+key+":"+type;if(detectedStrings.has(dedupeKey))xlateDebug("[XLATE][Capture] Skip save - dedupe hit",dedupeKey);else{detectedStrings.add(dedupeKey),xlateDebug("[XLATE][Capture] Saving key",key,"component",component,"type",type,"snippet:",abbreviateValue(text));var pageCourseId=0;"undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?pageCourseId=window.XLATE_COURSEID:"undefined"!=typeof M&&M.cfg&&M.cfg.courseid&&(pageCourseId=M.cfg.courseid);var curLang=window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en",reviewedFlag=curLang===(window.__XLATE__&&window.__XLATE__.sourceLang||window.__XLATE__&&window.__XLATE__.captureSourceLang||"en")?1:0,payload={component:component,key:key,source:text,lang:curLang,translation:text,reviewed:reviewedFlag,courseid:pageCourseId,context:component};xlateDebug("[XLATE][Capture] Ajax save payload",{key:key,component:component,type:type,lang:curLang,courseid:pageCourseId,reviewed:reviewedFlag,length:text.length}),Ajax.call([{methodname:"local_xlate_save_key",args:payload}])[0].then((function(response){return window.__XLATE__&&(window.__XLATE__.map||(window.__XLATE__.map={}),window.__XLATE__.map[key]=text,window.__XLATE__.reviewMap||(window.__XLATE__.reviewMap={}),window.__XLATE__.reviewMap[key]=1),xlateDebug("[XLATE][Capture] Save success",key,response||""),!0})).catch((function(err){detectedStrings.delete(dedupeKey),xlateDebug("[XLATE][Capture] Save failed",key,err&&err.message?err.message:err)}))}}else xlateDebug("[XLATE][Capture] Skip save - not translatable",key,describeElementContext(element))}function shouldIgnoreElement(element){if(!element||!element.tagName)return!0;var tagName=element.tagName.toLowerCase();if(-1!==["script","style","meta","link","noscript","head"].indexOf(tagName))return!0;if(window.XLATE_EXCLUDE_SELECTORS&&Array.isArray(window.XLATE_EXCLUDE_SELECTORS))for(var i=0;i<window.XLATE_EXCLUDE_SELECTORS.length;i++){var sel=window.XLATE_EXCLUDE_SELECTORS[i];if(sel)try{if(element.matches(sel)||element.closest&&element.closest(sel))return!0}catch(e){xlateDebug("[XLATE][DEBUG] Invalid selector:",sel,e)}}if(element.hasAttribute("data-xlate-ignore")||element.closest("[data-xlate-ignore]"))return!0;for(var currentPath=window.location.pathname||"",adminPaths=["/admin/","/local/xlate/","/course/modedit.php"],p=0;p<adminPaths.length;p++)if(0===currentPath.indexOf(adminPaths[p]))return!0;return!1}function collectKeysFromElement(el,keySet){var attrs=el&&el.attributes;if(attrs)for(var j=0;j<attrs.length;j++){var a=attrs[j],name=a&&a.name;if(name&&0===name.indexOf("data-xlate-key-")){var val=a.value;val&&(keySet[val]=!0)}}}function processCandidateValue(element,value,attrName,tagOnly,isCapture,map){if(value){var existingKey=getKeyFromAttributes(element,attrName),detectionValue=extractPlainText(value);if(existingKey||isTranslatableText(detectionValue)){var key=existingKey||generateKey(element,value,attrName);if(key)if(existingKey||setKeyAttribute(element,attrName,key),tagOnly)isCapture&&xlateDebug("[XLATE][Capture] Tag-only pass recorded key",key,"for",attrName,describeElementContext(element));else if(isCapture)saveToDatabase(element,value,attrName,key,map);else shouldShowTranslations()?map&&(hasTranslation(map,key)?translateElement(element,attrName,map):function(key){if(!key||pendingTranslationKeys.has(key)||requestedTranslationKeys.has(key))return;if(!window.__XLATE__||window.__XLATE__.isCapture)return;pendingTranslationKeys.add(key),function(){if(null!==missingFetchTimer)return;missingFetchTimer=window.setTimeout((function(){if(missingFetchTimer=null,pendingTranslationKeys&&0!==pendingTranslationKeys.size){var keys=[];pendingTranslationKeys.forEach((function(k){keys.push(k)})),pendingTranslationKeys.clear(),function(keys){if(!keys||!keys.length)return;if(!window.__XLATE__||window.__XLATE__.isCapture)return;var bundleUrl=window.__XLATE__.bundleUrl||"";if(!bundleUrl)return;fetch(bundleUrl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keys})}).then((function(response){return response.json()})).then((function(data){var map=window.__XLATE__.map||{},translations=data&&data.translations?data.translations:data;if(!translations||"object"!=typeof translations)return markKeysAsRequested(keys),null;var sourceUpdates=data&&data.sources&&"object"==typeof data.sources?data.sources:null;sourceUpdates&&(window.__XLATE__.sourceStrings&&"object"==typeof window.__XLATE__.sourceStrings||(window.__XLATE__.sourceStrings={}),Object.keys(sourceUpdates).forEach((function(k){window.__XLATE__.sourceStrings[k]=sourceUpdates[k]})));var updated=function(map,translations){var updated=!1;return Object.keys(translations).forEach((function(k){var value=translations[k];Object.prototype.hasOwnProperty.call(map,k)&&map[k]===value||(map[k]=value,updated=!0)})),updated}(map,translations),reviewChanged=function(reviewUpdates){if(!reviewUpdates||"object"!=typeof reviewUpdates)return!1;window.__XLATE__.reviewMap||(window.__XLATE__.reviewMap={});var reviewChanged=!1;return Object.keys(reviewUpdates).forEach((function(k){var incoming=reviewUpdates[k];window.__XLATE__.reviewMap[k]!==incoming&&(reviewChanged=!0),window.__XLATE__.reviewMap[k]=incoming})),reviewChanged}(data&&data.reviewed?data.reviewed:null);return(updated||reviewChanged)&&(window.__XLATE__.map=map,function(translations,sources){if(!window.__XLATE__.cacheKey)return;try{var cached=localStorage.getItem(window.__XLATE__.cacheKey),cachedPayload=cached?JSON.parse(cached):null,cachedTranslations={},cachedReviewed={},cachedSources={};cachedPayload&&"object"==typeof cachedPayload&&(cachedPayload.translations&&"object"==typeof cachedPayload.translations?(cachedTranslations=cachedPayload.translations,cachedReviewed=cachedPayload.reviewed||{},cachedSources=cachedPayload.sources||cachedPayload.sourceStrings||{}):Array.isArray(cachedPayload)||(cachedTranslations=cachedPayload)),Object.keys(translations||{}).forEach((function(k){cachedTranslations[k]=translations[k]}));var reviewMap=window.__XLATE__.reviewMap||{};Object.keys(reviewMap).forEach((function(k){cachedReviewed[k]=reviewMap[k]})),sources&&"object"==typeof sources&&Object.keys(sources).forEach((function(k){cachedSources[k]=sources[k]})),localStorage.setItem(window.__XLATE__.cacheKey,JSON.stringify({translations:cachedTranslations,reviewed:cachedReviewed,sources:cachedSources}))}catch(e){}}(translations,sourceUpdates),processedElements=new WeakSet,walk(document.body,map,!1)),markKeysAsRequested(keys),null})).catch((function(err){return function(keys){keys.forEach((function(k){requestedTranslationKeys.delete(k)}))}(keys),xlateDebug("[XLATE] Missing translation fetch failed",err),null}))}(keys)}}),200)}()}(key)):renderOriginalElement(element,attrName,key);else isCapture&&xlateDebug("[XLATE][Capture] Failed to generate key",attrName,describeElementContext(element),"snippet:",abbreviateValue(value))}else isCapture&&xlateDebug("[XLATE][Capture] Non-translatable value skipped",attrName,describeElementContext(element),"snippet:",abbreviateValue(value))}else isCapture&&xlateDebug("[XLATE][Capture] Empty value ignoring",attrName,describeElementContext(element))}function processElement(element,map,tagOnly){if(!shouldIgnoreElement(element)&&!processedElements.has(element)){var tagName=element.tagName?element.tagName.toLowerCase():"";if(element.parentElement&&element.parentElement.hasAttribute("data-xlate-key-content")&&-1!==INLINE_PIGGYBACK_TAGS.indexOf(tagName))return window.__XLATE__&&window.__XLATE__.isCapture&&xlateDebug("[XLATE][Capture] Skipping inline child inside keyed parent",describeElementContext(element)),void processedElements.add(element);processedElements.add(element);var isCapture=(window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en")===(window.__XLATE__&&window.__XLATE__.sourceLang||window.__XLATE__&&window.__XLATE__.captureSourceLang||"en"),skipTextCapture=!1;if(element.querySelector&&element.querySelector(BLOCK_CHILD_SELECTOR))getDirectChildText(element)||(skipTextCapture=!0,window.__XLATE__&&window.__XLATE__.isCapture&&xlateDebug("[XLATE][Capture] Skipping container without direct text",describeElementContext(element)));if(!skipTextCapture){var sourceText=getElementSourcePayload(element);processCandidateValue(element,sourceText,"text",tagOnly,isCapture,map)}ATTRIBUTE_TYPES.forEach((function(attr){if(element.hasAttribute(attr)){var value=element.getAttribute(attr).trim();processCandidateValue(element,value,attr,tagOnly,isCapture,map)}}))}}function markKeysAsRequested(keys){keys.forEach((function(k){requestedTranslationKeys.add(k)}))}function walk(root,map,tagOnly){if(root){var captureSelectors=window.XLATE_CAPTURE_SELECTORS&&Array.isArray(window.XLATE_CAPTURE_SELECTORS)&&window.XLATE_CAPTURE_SELECTORS.length?window.XLATE_CAPTURE_SELECTORS:null,roots=[];captureSelectors?(captureSelectors.forEach((function(sel){try{for(var found=document.querySelectorAll(sel),i=0;i<found.length;i++)roots.push(found[i])}catch(e){}})),roots.length||(roots=[root])):roots=[root],roots.forEach((function(scanRoot){for(var stack=[scanRoot];stack.length;){var el=stack.pop();if(1===el.nodeType){if(shouldIgnoreElement(el))continue;processElement(el,map,tagOnly);for(var children=el.children||[],i=0;i<children.length;i++)stack.push(children[i])}}}))}}function run(map){try{walk(document.body,map||{}),setTimeout((function(){walk(document.body,map||{})}),1e3),setTimeout((function(){walk(document.body,map||{})}),3e3),setTimeout((function(){walk(document.body,map||{})}),6e3),new MutationObserver((function(muts){muts.forEach((function(mutation){Array.prototype.slice.call(mutation.addedNodes||[]).forEach((function(node){1===node.nodeType&&walk(node,map||{})}))}))})).observe(document.body,{childList:!0,subtree:!0}),"function"==typeof window.addEventListener&&["focus","click","scroll"].forEach((function(eventType){document.addEventListener(eventType,(function(){var now=Date.now();now-lastProcessTime>250&&(lastProcessTime=now,setTimeout((function(){walk(document.body,map||{})}),100))}),!0)}))}finally{document.documentElement.classList.remove("xlate-loading")}}function getSourceForElementAttr(el,typename){if(!el)return"";if("content"===typename)return getElementSourcePayload(el);try{return el.getAttribute(typename)||""}catch(e){return""}}function initCaptureMode(config,courseId){xlateDebug("[XLATE] Capture mode - starting tag-only pass"),processedElements=new WeakSet,walk(document.body,{},!0);var collected=function(root){for(var keySet={},keyDetails={},all=root&&root.querySelectorAll?root.querySelectorAll("*"):[],i=0;i<all.length;i++){var el=all[i];collectKeysFromElement(el,keySet);var attrs=el&&el.attributes;if(attrs)for(var j=0;j<attrs.length;j++){var attrname=attrs[j]&&attrs[j].name;if(attrname&&0===attrname.indexOf("data-xlate-key-")){var aval=attrs[j].value;if(aval&&!keyDetails[aval]){var src=getSourceForElementAttr(el,attrname.substring("data-xlate-key-".length));keyDetails[aval]={component:detectComponent(el),source:src}}}}}return{keySet:keySet,keyDetails:keyDetails}}(document),keySetCap=collected.keySet,keyDetails=collected.keyDetails,keysCap=Object.keys(keySetCap);if(xlateDebug("[XLATE] Collected",keysCap.length,"keys from DOM"),!keysCap.length)return xlateDebug("[XLATE] No keys found, skipping bundle fetch"),void run({});xlateDebug("[XLATE] Fetching bundle to check existing keys..."),fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keysCap})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map,sourceMap=map&&map.sourceMap?map.sourceMap:{},reviewMap=map&&map.reviewed&&"object"==typeof map.reviewed?map.reviewed:{},sourceStrings=map&&map.sources&&"object"==typeof map.sources?map.sources:{},associations=map&&map.associations?map.associations:{};return translations&&"object"==typeof translations||(translations={}),window.__XLATE__.map=translations,window.__XLATE__.sourceMap=sourceMap,window.__XLATE__.sourceStrings=sourceStrings,window.__XLATE__.reviewMap=reviewMap,xlateDebug("[XLATE] Bundle returned",Object.keys(translations).length,"existing translations"),function(keys,keyDetails,associations,courseId){if(courseId&&associations&&"object"==typeof associations){for(var toAssociate=[],ti=0;ti<keys.length;ti++){var key=keys[ti];if(!associations[key]){var detail=keyDetails[key]||null;detail&&toAssociate.push({component:detail.component,key:key,source:detail.source||""})}}if(toAssociate.length){xlateDebug("[XLATE] Associating",toAssociate.length,"keys with course",courseId);try{Ajax.call([{methodname:"local_xlate_associate_keys",args:{keys:toAssociate,courseid:courseId,context:""}}])}catch(e){xlateDebug("[XLATE] Bulk-associate exception",e)}}}}(keysCap,keyDetails,associations,courseId),processedElements=new WeakSet,walk(document.body,translations,!1),run(translations),!0})).catch((function(err){xlateDebug("[XLATE] Bundle fetch failed:",err),processedElements=new WeakSet,walk(document.body,{},!1),run({})}))}function initTranslationMode(config){xlateDebug("[XLATE] Translation mode - starting tag-only pass");try{processedElements=new WeakSet,walk(document.body,{},!0);for(var keySet={},all=document.querySelectorAll("*"),i=0;i<all.length;i++)collectKeysFromElement(all[i],keySet);var keys=Object.keys(keySet);if(!keys.length)return void run({});var cacheKey="xlate:"+config.lang+":"+config.version+":keys:"+keys.length;window.__XLATE__.cacheKey=cacheKey;var cachedPayload=function(cacheKey){if(!cacheKey)return null;try{var cached=localStorage.getItem(cacheKey);if(!cached)return null;var payload=JSON.parse(cached);if(!payload||"object"!=typeof payload)return null;if(payload.translations&&"object"==typeof payload.translations)return{translations:payload.translations,reviewed:payload.reviewed||{},sources:payload.sources||payload.sourceStrings||{}};if(!Array.isArray(payload))return{translations:payload,reviewed:{},sources:{}}}catch(e){return null}return null}(cacheKey);cachedPayload&&(window.__XLATE__.map=cachedPayload.translations,window.__XLATE__.reviewMap=cachedPayload.reviewed,window.__XLATE__.sourceStrings=cachedPayload.sources||{},processedElements=new WeakSet,run(cachedPayload.translations)),fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keys})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map,reviewMap=map&&map.reviewed&&"object"==typeof map.reviewed?map.reviewed:{},sourceStrings=map&&map.sources&&"object"==typeof map.sources?map.sources:{};translations&&"object"==typeof translations||(translations={});try{localStorage.setItem(cacheKey,JSON.stringify({translations:translations,reviewed:reviewMap,sources:sourceStrings}))}catch(e){}return window.__XLATE__.map=translations,window.__XLATE__.reviewMap=reviewMap,window.__XLATE__.sourceStrings=sourceStrings,processedElements=new WeakSet,run(translations),!0})).catch((function(){run({})}))}catch(err){run({})}}function init(config){if(document.documentElement.classList.add("xlate-loading"),config.isEditing)return xlateDebug("[XLATE] Edit mode detected (isEditing=true): skipping translation/capture logic."),void document.documentElement.classList.remove("xlate-loading");window.__XLATE__=function(config){var resolvedSourceLang=config.sourceLang||config.captureSourceLang||config.lang||"en",targetLangs=Array.isArray(config.targetLangs)?config.targetLangs:[],enabledLangs=Array.isArray(config.enabledLangs)?config.enabledLangs:[],state={lang:config.lang,sourceLang:resolvedSourceLang,captureSourceLang:config.captureSourceLang||resolvedSourceLang,targetLangs:targetLangs,enabledLangs:enabledLangs,map:{},sourceMap:{},sourceStrings:{},reviewMap:{},bundleUrl:config.bundleurl||"",version:config.version||"",cacheKey:"",inlineIndicator:!!config.showInlineIndicators};return state.isCapture=config.lang===state.captureSourceLang,state.isTargetLang=!state.targetLangs.length||-1!==state.targetLangs.indexOf(config.lang),state}(config),window.__XLATE__.showTranslations=!0,window.__XLATE__.setTranslationVisibility=setTranslationVisibility,window.__XLATE__.toggleTranslations=function(){setTranslationVisibility()},window.__XLATE__.canToggleTranslations=!window.__XLATE__.isCapture&&!1!==window.__XLATE__.isTargetLang,"undefined"!=typeof document&&document.documentElement&&document.documentElement.classList.remove("xlate-original-visible"),dispatchXlateEvent("xlate:ready",{isTargetLang:window.__XLATE__.isTargetLang,isCapture:window.__XLATE__.isCapture}),dispatchXlateEvent("xlate:visibilitychange",{visible:shouldShowTranslations()});var courseId="undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?window.XLATE_COURSEID:"undefined"!=typeof M&&M.cfg&&M.cfg.courseid?M.cfg.courseid:null;if(xlateDebug("[XLATE] Initializing:",{currentLang:config.lang,sourceLang:window.__XLATE__.sourceLang,captureSourceLang:window.__XLATE__.captureSourceLang,targetLangs:window.__XLATE__.targetLangs,isCapture:window.__XLATE__.isCapture,isTargetLang:window.__XLATE__.isTargetLang,courseId:courseId}),!window.__XLATE__.isCapture)return window.__XLATE__.isTargetLang?void initTranslationMode(config):(xlateDebug("[XLATE] Current language is not a configured target; skipping translation runtime."),void document.documentElement.classList.remove("xlate-loading"));initCaptureMode(config,courseId)}return Translator.utils={},Translator.keys={},Translator.attrs={},Translator.capture={},Translator.dom={},Translator.api={},Translator.utils.collectContextClasses=collectContextClasses,Translator.utils.collectDataAttributes=collectDataAttributes,Translator.utils.isTranslatableText=isTranslatableText,Translator.utils.simpleHash=simpleHash,Translator.utils.hasTranslation=hasTranslation,Translator.keys.generateKey=generateKey,Translator.keys.generateKey=generateKey,Translator.attrs.setKeyAttribute=setKeyAttribute,Translator.attrs.setKeyAttribute=setKeyAttribute,Translator.attrs.getKeyFromAttributes=getKeyFromAttributes,Translator.attrs.getKeyFromAttributes=getKeyFromAttributes,Translator.capture.translateElement=translateElement,Translator.capture.translateElement=translateElement,Translator.capture.detectComponent=detectComponent,Translator.capture.detectComponent=detectComponent,Translator.capture.saveToDatabase=saveToDatabase,Translator.capture.saveToDatabase=saveToDatabase,Translator.dom.shouldIgnoreElement=shouldIgnoreElement,Translator.dom.collectKeysFromElement=collectKeysFromElement,Translator.dom.processElement=processElement,Translator.dom.walk=walk,Translator.dom.walk=walk,Translator.api.run=run,Translator.api.setTranslationVisibility=setTranslationVisibility,Translator.api.init=init,Translator.run=run,Translator.init=init,Translator}));

//# sourceMappingURL=translator.min.js.map