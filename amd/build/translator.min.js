define("local_xlate/translator",["core/ajax"],(function(Ajax){var ATTRIBUTE_TYPES=["placeholder","title","alt","aria-label"],detectedStrings=new Set,processedElements=new WeakSet,lastProcessTime=0,Translator={};function xlateDebug(){"undefined"!=typeof window&&window.XLATE_DEBUG&&("undefined"!=typeof console&&"function"==typeof console.debug?console.debug.apply(console,arguments):"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments))}function collectContextClasses(element){if(!element||!element.classList)return"";var blacklist=["active","show","hide","hidden","collapsed","expanded","d-flex","d-none","d-block","sr-only","visually-hidden"],classes=[];return Array.prototype.forEach.call(element.classList,(function(cls){cls&&cls.length>2&&-1===blacklist.indexOf(cls)&&!/^[0-9]/.test(cls)&&!/^[mp][tblr]?-[0-5]$/.test(cls)&&classes.push(cls)})),classes.join(",")}function collectDataAttributes(element){if(!element||!element.attributes)return"";for(var dataAttrs=[],i=0;i<element.attributes.length;i++){var attr=element.attributes[i];0===attr.name.indexOf("data-")&&0!==attr.name.indexOf("data-xlate")&&attr.value&&dataAttrs.push(attr.value)}return dataAttrs.join(",")}function simpleHash(str){for(var h1=2166136261,h2=2654435761,i=0;i<str.length;i++){var c=str.charCodeAt(i);h1^=c,h1=Math.imul(h1,16777619);var k=(h2=h2+c>>>0)^h2>>>16;k=(h2=Math.imul(k,2246822507))^h2>>>13,h2=((h2=Math.imul(k,3266489909))^h2>>>16)>>>0}var s=(h1>>>0).toString(36)+(h2>>>0).toString(36);return s.length<12?s=(s+"qwertyuiopasdfghjklz").substring(0,12):s.length>12&&(s=s.substring(0,12)),s}function isTranslatableText(text){if(!text||text.length<3)return!1;if((text.match(/[a-zA-Z]/g)||[]).length<.3*text.length)return!1;return-1===["ok","id","url","api"].indexOf(text.toLowerCase())}function generateKey(element,text,type){if(!element||!text)return"";var parts=[],parent=element.parentElement;if(parent&&parent.tagName){parts.push(parent.tagName.toLowerCase());var parentClasses=collectContextClasses(parent);parentClasses&&parts.push(parentClasses);var parentData=collectDataAttributes(parent);parentData&&parts.push(parentData)}element.tagName&&parts.push(element.tagName.toLowerCase());var classes=collectContextClasses(element);classes&&parts.push(classes);var dataAttrs=collectDataAttributes(element);dataAttrs&&parts.push(dataAttrs),type&&"text"!==type&&parts.push(type);for(var directText="",i=0;i<element.childNodes.length;i++){var node=element.childNodes[i];3===node.nodeType&&(directText+=node.textContent)}return directText=directText.trim(),parts.push(directText),simpleHash(parts.join("."))}function setKeyAttribute(element,type,key){if(element&&key){var attrType="text"===type?"content":type;element.setAttribute("data-xlate-key-"+attrType,key)}}function getKeyFromAttributes(element,type){if(!element)return null;var attrType="text"===type?"content":type;return element.getAttribute("data-xlate-key-"+attrType)}function translateElement(element,type,map){var key=getKeyFromAttributes(element,type);key&&map[key]&&("text"===type?element.textContent=map[key]:element.setAttribute(type,map[key]))}function detectComponent(element){if(!element)return"core";var container=element.closest("[data-region]");if(container){var region=container.getAttribute("data-region");if(region)return"region_"+region}if(container=element.closest(".block")){var blockClass=container.className.match(/block_(\w+)/);if(blockClass)return"block_"+blockClass[1]}return document.body.classList.contains("path-admin")?"admin":"core"}function saveToDatabase(element,text,type,key,existingMap){if(existingMap&&existingMap[key])xlateDebug("[XLATE] Skipping save - key exists:",key);else{var component=detectComponent(element),dedupeKey=component+":"+key+":"+type;if(!detectedStrings.has(dedupeKey)){detectedStrings.add(dedupeKey),xlateDebug("[XLATE] Saving new key:",key,"component:",component,"text:",text.substring(0,50));var pageCourseId=0;"undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?pageCourseId=window.XLATE_COURSEID:"undefined"!=typeof M&&M.cfg&&M.cfg.courseid&&(pageCourseId=M.cfg.courseid),Ajax.call([{methodname:"local_xlate_save_key",args:{component:component,key:key,source:text,lang:window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en",translation:text,courseid:pageCourseId,context:component}}])[0].then((function(){return window.__XLATE__&&(window.__XLATE__.map||(window.__XLATE__.map={}),window.__XLATE__.map[key]=text),!0})).catch((function(){detectedStrings.delete(dedupeKey)}))}}}function shouldIgnoreElement(element){if(!element||!element.tagName)return!0;var tagName=element.tagName.toLowerCase();if(-1!==["script","style","meta","link","noscript","head"].indexOf(tagName))return!0;if(window.XLATE_EXCLUDE_SELECTORS&&Array.isArray(window.XLATE_EXCLUDE_SELECTORS))for(var i=0;i<window.XLATE_EXCLUDE_SELECTORS.length;i++){var sel=window.XLATE_EXCLUDE_SELECTORS[i];if(sel)try{if(element.matches(sel)||element.closest&&element.closest(sel))return!0}catch(e){xlateDebug("[XLATE][DEBUG] Invalid selector:",sel,e)}}if(element.hasAttribute("data-xlate-ignore")||element.closest("[data-xlate-ignore]"))return!0;for(var currentPath=window.location.pathname||"",adminPaths=["/admin/","/local/xlate/","/course/modedit.php"],p=0;p<adminPaths.length;p++)if(0===currentPath.indexOf(adminPaths[p]))return!0;for(var adminSelectors=[".navbar",".navigation",".breadcrumb",".drawer",".tooltip"],s=0;s<adminSelectors.length;s++)if(element.closest(adminSelectors[s]))return!0;return!1}function collectKeysFromElement(el,keySet){var attrs=el&&el.attributes;if(attrs)for(var j=0;j<attrs.length;j++){var a=attrs[j],name=a&&a.name;if(name&&0===name.indexOf("data-xlate-key-")){var val=a.value;val&&(keySet[val]=!0)}}}function processElement(element,map,tagOnly){if(!shouldIgnoreElement(element)&&!processedElements.has(element)){processedElements.add(element);for(var isCapture=(window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en")===(window.__XLATE__&&window.__XLATE__.siteLang||"en"),directText="",i=0;i<element.childNodes.length;i++){var node=element.childNodes[i];3===node.nodeType&&(directText+=node.textContent)}if((directText=directText.trim())&&isTranslatableText(directText)){var textKey=generateKey(element,directText,"text");textKey&&(setKeyAttribute(element,"text",textKey),tagOnly||(isCapture?saveToDatabase(element,directText,"text",textKey,map):map&&translateElement(element,"text",map)))}ATTRIBUTE_TYPES.forEach((function(attr){if(element.hasAttribute(attr)){var value=element.getAttribute(attr).trim();if(value&&isTranslatableText(value)){var attrKey=generateKey(element,value,attr);attrKey&&(setKeyAttribute(element,attr,attrKey),tagOnly||(isCapture?saveToDatabase(element,value,attr,attrKey,map):map&&translateElement(element,attr,map)))}}}))}}function walk(root,map,tagOnly){if(root){var captureSelectors=window.XLATE_CAPTURE_SELECTORS&&Array.isArray(window.XLATE_CAPTURE_SELECTORS)&&window.XLATE_CAPTURE_SELECTORS.length?window.XLATE_CAPTURE_SELECTORS:null,roots=[];captureSelectors?(captureSelectors.forEach((function(sel){try{for(var found=document.querySelectorAll(sel),i=0;i<found.length;i++)roots.push(found[i])}catch(e){}})),roots.length||(roots=[root])):roots=[root],roots.forEach((function(scanRoot){for(var stack=[scanRoot];stack.length;){var el=stack.pop();if(1===el.nodeType){if(shouldIgnoreElement(el))continue;processElement(el,map,tagOnly);for(var children=el.children||[],i=0;i<children.length;i++)stack.push(children[i])}}}))}}function run(map){try{walk(document.body,map||{}),setTimeout((function(){walk(document.body,map||{})}),1e3),setTimeout((function(){walk(document.body,map||{})}),3e3),setTimeout((function(){walk(document.body,map||{})}),6e3),new MutationObserver((function(muts){muts.forEach((function(mutation){Array.prototype.slice.call(mutation.addedNodes||[]).forEach((function(node){1===node.nodeType&&walk(node,map||{})}))}))})).observe(document.body,{childList:!0,subtree:!0}),"function"==typeof window.addEventListener&&["focus","click","scroll"].forEach((function(eventType){document.addEventListener(eventType,(function(){var now=Date.now();now-lastProcessTime>250&&(lastProcessTime=now,setTimeout((function(){walk(document.body,map||{})}),100))}),!0)}))}finally{document.documentElement.classList.remove("xlate-loading")}}function init(config){if(document.documentElement.classList.add("xlate-loading"),config.isEditing)return xlateDebug("[XLATE] Edit mode detected (isEditing=true): skipping translation/capture logic."),void document.documentElement.classList.remove("xlate-loading");window.__XLATE__={lang:config.lang,siteLang:config.siteLang,map:{},sourceMap:{}};var currentLang=config.lang,siteLang=config.siteLang,isCapture=currentLang===siteLang,courseId=null;if("undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?courseId=window.XLATE_COURSEID:"undefined"!=typeof M&&M.cfg&&M.cfg.courseid&&(courseId=M.cfg.courseid),xlateDebug("[XLATE] Initializing:",{currentLang:currentLang,siteLang:siteLang,isCapture:isCapture,courseId:courseId}),isCapture){xlateDebug("[XLATE] Capture mode - starting tag-only pass"),processedElements=new WeakSet,walk(document.body,{},!0);for(var keySetCap={},allCap=document.querySelectorAll("*"),ci=0;ci<allCap.length;ci++)collectKeysFromElement(allCap[ci],keySetCap);var keysCap=Object.keys(keySetCap);return xlateDebug("[XLATE] Collected",keysCap.length,"keys from DOM"),0===keysCap.length?(xlateDebug("[XLATE] No keys found, skipping bundle fetch"),void run({})):(xlateDebug("[XLATE] Fetching bundle to check existing keys..."),void fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keysCap})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map;return translations&&"object"==typeof translations||(translations={}),window.__XLATE__.map=translations,xlateDebug("[XLATE] Bundle returned",Object.keys(translations).length,"existing translations"),processedElements=new WeakSet,walk(document.body,translations,!1),run(translations),!0})).catch((function(err){xlateDebug("[XLATE] Bundle fetch failed:",err),processedElements=new WeakSet,walk(document.body,{},!1),run({})})))}xlateDebug("[XLATE] Translation mode - starting tag-only pass");try{processedElements=new WeakSet,walk(document.body,{},!0);for(var keySet={},all=document.querySelectorAll("*"),i=0;i<all.length;i++)collectKeysFromElement(all[i],keySet);var keys=Object.keys(keySet);if(0===keys.length)return void run({});var k="xlate:"+config.lang+":"+config.version+":keys:"+keys.length,cached=null;try{cached=localStorage.getItem(k)}catch(e){}if(cached)try{var cachedMap=JSON.parse(cached);cachedMap&&"object"==typeof cachedMap&&(window.__XLATE__.map=cachedMap,processedElements=new WeakSet,run(cachedMap))}catch(e){}fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keys})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map;translations&&"object"==typeof translations||(translations={});try{localStorage.setItem(k,JSON.stringify(translations))}catch(e){}return window.__XLATE__.map=translations,processedElements=new WeakSet,run(translations),!0})).catch((function(){run({})}))}catch(err){run({})}}return Translator.utils={},Translator.keys={},Translator.attrs={},Translator.capture={},Translator.dom={},Translator.api={},Translator.utils.collectContextClasses=collectContextClasses,Translator.utils.collectDataAttributes=collectDataAttributes,Translator.utils.isTranslatableText=isTranslatableText,Translator.utils.simpleHash=simpleHash,Translator.keys.generateKey=generateKey,Translator.keys.generateKey=generateKey,Translator.attrs.setKeyAttribute=setKeyAttribute,Translator.attrs.setKeyAttribute=setKeyAttribute,Translator.attrs.getKeyFromAttributes=getKeyFromAttributes,Translator.attrs.getKeyFromAttributes=getKeyFromAttributes,Translator.capture.translateElement=translateElement,Translator.capture.translateElement=translateElement,Translator.capture.detectComponent=detectComponent,Translator.capture.detectComponent=detectComponent,Translator.capture.saveToDatabase=saveToDatabase,Translator.capture.saveToDatabase=saveToDatabase,Translator.dom.shouldIgnoreElement=shouldIgnoreElement,Translator.dom.collectKeysFromElement=collectKeysFromElement,Translator.dom.processElement=processElement,Translator.dom.walk=walk,Translator.dom.walk=walk,Translator.api.run=run,Translator.api.init=init,Translator.run=run,Translator.init=init,Translator}));

//# sourceMappingURL=translator.min.js.map