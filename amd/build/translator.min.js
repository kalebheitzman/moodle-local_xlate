define("local_xlate/translator",["core/ajax"],(function(Ajax){var ATTRIBUTE_TYPES=["placeholder","title","alt","aria-label"],autoDetectEnabled=!0,detectedStrings=new Set,processedElements=new WeakSet,lastProcessTime=0;function collectContextClasses(element){if(!element||!element.classList)return"";var blacklist=["active","show","hide","hidden","collapsed","expanded","d-flex","d-none","d-block","sr-only","visually-hidden"],classes=[];return Array.prototype.forEach.call(element.classList,(function(cls){cls&&cls.length>2&&-1===blacklist.indexOf(cls)&&!/^[0-9]/.test(cls)&&!/^[mp][tblr]?-[0-5]$/.test(cls)&&classes.push(cls)})),classes.join(",")}function collectDataAttributes(element){if(!element||!element.attributes)return"";for(var dataAttrs=[],i=0;i<element.attributes.length;i++){var attr=element.attributes[i];0===attr.name.indexOf("data-")&&0!==attr.name.indexOf("data-xlate")&&attr.value&&dataAttrs.push(attr.value)}return dataAttrs.join(",")}function generateKey(element,text,type){if(!element||!text)return"";var parts=[],parent=element.parentElement;if(parent&&parent.tagName){parts.push(parent.tagName.toLowerCase());var parentClasses=collectContextClasses(parent);parentClasses&&parts.push(parentClasses);var parentData=collectDataAttributes(parent);parentData&&parts.push(parentData)}element.tagName&&parts.push(element.tagName.toLowerCase());var classes=collectContextClasses(element);classes&&parts.push(classes);var dataAttrs=collectDataAttributes(element);return dataAttrs&&parts.push(dataAttrs),type&&"text"!==type&&parts.push(type),parts.push(text),function(str){for(var h1=2166136261,h2=2654435761,i=0;i<str.length;i++){var c=str.charCodeAt(i);h1^=c,h1=Math.imul(h1,16777619);var k=(h2=h2+c>>>0)^h2>>>16;k=(h2=Math.imul(k,2246822507))^h2>>>13,h2=((h2=Math.imul(k,3266489909))^h2>>>16)>>>0}var s=(h1>>>0).toString(36)+(h2>>>0).toString(36);return s.length<12?s=(s+"qwertyuiopasdfghjklz").substring(0,12):s.length>12&&(s=s.substring(0,12)),s}(parts.join("."))}function setKeyAttribute(element,type,key){if(element&&key){var attrType="text"===type?"content":type;element.setAttribute("data-xlate-key-"+attrType,key)}}function translateElement(element,type,map){var key=function(element,type){if(!element)return null;var attrType="text"===type?"content":type;return element.getAttribute("data-xlate-key-"+attrType)}(element,type);key&&map[key]&&("text"===type?element.textContent=map[key]:element.setAttribute(type,map[key]))}function saveToDatabase(element,text,type,key){var component=function(element){if(!element)return"core";var container=element.closest("[data-region]");if(container){var region=container.getAttribute("data-region");if(region)return"region_"+region}if(container=element.closest(".block")){var blockClass=container.className.match(/block_(\w+)/);if(blockClass)return"block_"+blockClass[1]}return document.body.classList.contains("path-admin")?"admin":"core"}(element),dedupeKey=component+":"+key+":"+type;detectedStrings.has(dedupeKey)||(detectedStrings.add(dedupeKey),Ajax.call([{methodname:"local_xlate_save_key",args:{component:component,key:key,source:text,lang:window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en",translation:text}}])[0].then((function(){return window.__XLATE__&&(window.__XLATE__.map||(window.__XLATE__.map={}),window.__XLATE__.map[key]=text),!0})).catch((function(){detectedStrings.delete(dedupeKey)})))}function isTranslatableText(text){if(!text||text.length<3)return!1;if((text.match(/[a-zA-Z]/g)||[]).length<.3*text.length)return!1;return-1===["ok","id","url","api"].indexOf(text.toLowerCase())}function collectKeysFromElement(el,keySet){var attrs=el&&el.attributes;if(attrs)for(var j=0;j<attrs.length;j++){var a=attrs[j],name=a&&a.name;if(name&&0===name.indexOf("data-xlate-key-")){var val=a.value;val&&(keySet[val]=!0)}}}function processElement(element,map,tagOnly){if(!function(element){if(!element||!element.tagName)return!0;var tagName=element.tagName.toLowerCase();if(-1!==["script","style","meta","link","noscript","head"].indexOf(tagName))return!0;if(element.hasAttribute("data-xlate-ignore")||element.closest("[data-xlate-ignore]"))return!0;for(var currentPath=window.location.pathname||"",adminPaths=["/admin/","/local/xlate/","/course/modedit.php"],p=0;p<adminPaths.length;p++)if(0===currentPath.indexOf(adminPaths[p]))return!0;for(var adminSelectors=[".navbar",".navigation",".breadcrumb",".drawer",".tooltip"],s=0;s<adminSelectors.length;s++)if(element.closest(adminSelectors[s]))return!0;return!1}(element)&&!processedElements.has(element)){processedElements.add(element);var isCapture=(window.__XLATE__&&window.__XLATE__.lang||M.cfg.language||"en")===(window.__XLATE__&&window.__XLATE__.siteLang||"en")&&autoDetectEnabled,textContent=function(element){if(!element)return"";if(0===element.children.length)return element.textContent.trim();for(var simpleFormatting=!0,i=0;i<element.children.length;i++){var tag=element.children[i].tagName.toLowerCase();if(-1===["b","i","em","strong","span","small"].indexOf(tag)){simpleFormatting=!1;break}}return simpleFormatting?element.textContent.trim():""}(element);if(textContent&&isTranslatableText(textContent)){var textKey=generateKey(element,textContent,"text");textKey&&(setKeyAttribute(element,"text",textKey),tagOnly||(isCapture?saveToDatabase(element,textContent,"text",textKey):map&&translateElement(element,"text",map)))}ATTRIBUTE_TYPES.forEach((function(attr){if(element.hasAttribute(attr)){var value=element.getAttribute(attr).trim();if(value&&isTranslatableText(value)){var attrKey=generateKey(element,value,attr);attrKey&&(setKeyAttribute(element,attr,attrKey),tagOnly||(isCapture?saveToDatabase(element,value,attr,attrKey):map&&translateElement(element,attr,map)))}}}))}}function walk(root,map,tagOnly){if(root)for(var stack=[root];stack.length;){var el=stack.pop();if(1===el.nodeType){el.hasAttribute&&!el.hasAttribute("data-xlate-ignore")&&processElement(el,map,tagOnly);for(var children=el.children||[],i=0;i<children.length;i++)stack.push(children[i])}}}function run(map){try{walk(document.body,map||{}),autoDetectEnabled&&setTimeout((function(){walk(document.body,map||{})}),1e3),new MutationObserver((function(muts){muts.forEach((function(mutation){Array.prototype.slice.call(mutation.addedNodes||[]).forEach((function(node){1===node.nodeType&&walk(node,map||{})}))}))})).observe(document.body,{childList:!0,subtree:!0}),"function"==typeof window.addEventListener&&["focus","click","scroll"].forEach((function(eventType){document.addEventListener(eventType,(function(){var now=Date.now();now-lastProcessTime>250&&(lastProcessTime=now,setTimeout((function(){walk(document.body,map||{})}),100))}),!0)}))}finally{document.documentElement.classList.remove("xlate-loading")}}return{run:run,init:function(config){if(document.documentElement.classList.add("xlate-loading"),void 0!==config.autodetect&&(autoDetectEnabled=!(!1===config.autodetect||"false"===config.autodetect)),window.__XLATE__={lang:config.lang,siteLang:config.siteLang,map:{},sourceMap:{}},config.lang===config.siteLang&&autoDetectEnabled){if(processedElements=new WeakSet,walk(document.body,{},!1),run({}),config.loadBundleOnSiteLang)try{for(var keySetCap={},allCap=document.querySelectorAll("*"),ci=0;ci<allCap.length;ci++)collectKeysFromElement(allCap[ci],keySetCap);var keysCap=Object.keys(keySetCap);keysCap.length&&fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keysCap})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map;return translations&&"object"==typeof translations||(translations={}),window.__XLATE__.map=translations,!0})).catch((function(){}))}catch(spotErr){}}else try{processedElements=new WeakSet,walk(document.body,{},!0);for(var keySet={},all=document.querySelectorAll("*"),i=0;i<all.length;i++)collectKeysFromElement(all[i],keySet);var keys=Object.keys(keySet);if(0===keys.length)return void run({});var k="xlate:"+config.lang+":"+config.version+":keys:"+keys.length,cached=null;try{cached=localStorage.getItem(k)}catch(e){}if(cached)try{var cachedMap=JSON.parse(cached);cachedMap&&"object"==typeof cachedMap&&(window.__XLATE__.map=cachedMap,processedElements=new WeakSet,run(cachedMap))}catch(e){}fetch(config.bundleurl,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({keys:keys})}).then((function(response){return response.json()})).then((function(map){var translations=map&&map.translations?map.translations:map;translations&&"object"==typeof translations||(translations={});try{localStorage.setItem(k,JSON.stringify(translations))}catch(e){}return window.__XLATE__.map=translations,processedElements=new WeakSet,run(translations),!0})).catch((function(){run({})}))}catch(err){run({})}},setAutoDetect:function(enabled){autoDetectEnabled=!!enabled}}}));

//# sourceMappingURL=translator.min.js.map