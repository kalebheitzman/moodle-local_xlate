define("local_xlate/autotranslate",["core/ajax","core/notification"],(function(Ajax,notification){return{init:function(config){var button=document.getElementById("local_xlate_autotranslate");function startPolling(targetlang,items){var statusId="local_xlate_autotranslate_status",statusEl=document.getElementById(statusId);statusEl||((statusEl=document.createElement("div")).id=statusId,statusEl.style.position="fixed",statusEl.style.right="16px",statusEl.style.bottom="16px",statusEl.style.zIndex=1050,statusEl.style.maxWidth="320px",statusEl.style.background="white",statusEl.style.border="1px solid #ccc",statusEl.style.boxShadow="0 2px 6px rgba(0,0,0,0.1)",statusEl.style.padding="12px",statusEl.style.borderRadius="6px",document.body.appendChild(statusEl));for(var plainids=[],pi=0;pi<items.length;pi++)plainids.push(items[pi].key||items[pi].id||"");var total=plainids.length,translatedCount=0;var tries=0,pollHandle=setInterval((function(){tries+=1;var ids=plainids.slice();Ajax.call([{methodname:"local_xlate_autotranslate_progress",args:{items:ids,targetlang:targetlang}}])[0].then((function(progress){if(!(progress&&progress.success&&Array.isArray(progress.results)))return null;translatedCount=0;for(var k=0;k<progress.results.length;k++)progress.results[k].translated&&(translatedCount+=1);return function(list){var progressLine='<div style="margin-top:8px">'+translatedCount+" / "+total+" translated</div>";statusEl.innerHTML="<strong>Autotranslate</strong><br/>"+progressLine+'<div id="local_xlate_progress_list" style="margin-top:8px; max-height:200px; overflow:auto; font-size:90%"></div><div style="margin-top:8px; text-align:right"><button id="local_xlate_progress_close" class="btn btn-sm btn-secondary">Close</button></div>';var listEl=document.getElementById("local_xlate_progress_list");listEl.innerHTML="";for(var i=0;i<list.length;i++){var item=list[i],row=document.createElement("div");row.style.padding="2px 0",row.textContent=(item.id||"")+" — "+(item.translated?"✓":"..."),listEl.appendChild(row)}var closeBtn=document.getElementById("local_xlate_progress_close");closeBtn&&closeBtn.addEventListener("click",(function(){statusEl&&statusEl.parentNode&&statusEl.parentNode.removeChild(statusEl)}))}(progress.results),translatedCount>=total?(clearInterval(pollHandle),notification.alert("Autotranslate finished: "+translatedCount+" / "+total+" translated.")):tries>=40&&(clearInterval(pollHandle),notification.alert("Autotranslate polling timed out: "+translatedCount+" / "+total+".")),null})).catch((function(){return null}))}),3e3)}button&&button.addEventListener("click",(function(){var cards=Array.prototype.slice.call(document.querySelectorAll(".card.mb-3")),items=[];if("undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?window.XLATE_COURSEID:config&&config.courseid&&config.courseid,cards.forEach((function(card){try{var header=card.querySelector(".card-header strong");if(!header)return;var compkey=header.textContent.trim();if(!compkey||-1===compkey.indexOf("."))return;var parts=compkey.split("."),component=parts.slice(0,parts.length-1).join("."),xkey=parts[parts.length-1],sourceText="",srcel=card.querySelector(".form-control-plaintext");srcel&&(sourceText=srcel.textContent.trim()),items.push({id:component+":"+xkey,component:component,key:xkey,source_text:sourceText})}catch(e){}})),items.length){var targetcfg=config&&config.defaulttarget?config.defaulttarget:"",targets=Array.isArray(targetcfg)?targetcfg:[targetcfg];(targets=targets.map((function(t){return(t||"").toString().trim()})).filter((function(t){return""!==t}))).length?targets.forEach((function(target){Ajax.call([{methodname:"local_xlate_autotranslate",args:{sourcelang:config.sourcelang||"en",targetlang:[target],items:items,glossary:config.glossary||[],options:{}}}])[0].then((function(res){if(!res||!res.success){var reason=res&&(res.error||res.message)?res.error||res.message:null,msg="Failed to queue autotranslate task for "+target+(reason?": "+reason:".");return notification.alert(msg),null}return notification.alert("Autotranslate task queued for "+target+". Task id: "+(res.taskid||"n/a")),startPolling(target,items),null})).catch((function(err){var detail=function(err){try{return err?"string"==typeof err?err:err.error?"string"==typeof err.error?err.error:JSON.stringify(err.error):err.exception?err.exception+(err.message?": "+err.message:""):err.message?err.message:JSON.stringify(err):"Unknown error"}catch(e){return String(err)}}(err);return notification.alert("Error queuing autotranslate task for "+target+": "+detail),null}))})):notification.alert("No default target language configured. Please specify a target language in the Manage UI.")}else notification.alert("No visible translation keys found on this page.")}))}}}));

//# sourceMappingURL=autotranslate.min.js.map