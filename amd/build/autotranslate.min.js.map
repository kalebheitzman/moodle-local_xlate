{"version":3,"file":"autotranslate.min.js","sources":["../src/autotranslate.js"],"sourcesContent":["// AMD module to queue autotranslate for visible keys in Manage UI.\ndefine(['core/ajax', 'core/notification'], function (Ajax, notification) {\n    return {\n        init: function (config) {\n            var courseButton = document.getElementById('local_xlate_autotranslate_course');\n\n            // If the server passed an active job id but the Manage page card or\n            // its elements are not present (for example because the course\n            // filter was lost during navigation), create a small inline\n            // progress container and resume polling so the user still sees\n            // progress for their job.\n            if (config && config.currentjobid && !document.getElementById('local_xlate_course_progress')) {\n                try {\n                    // Append the progress container to the main content area if available,\n                    // otherwise append to document.body.\n                    var parent = document.getElementById('region-main') || document.body;\n                    var wrapper = document.createElement('div');\n                        wrapper.id = 'local_xlate_course_progress_wrapper';\n                        wrapper.style.margin = '12px 0';\n                        wrapper.innerHTML = '' +\n                                '<div id=\"local_xlate_course_progress\" style=\"display:block;\">' +\n                                    '<div style=\"font-size:90%; margin-bottom:6px\">' +\n                                        '<span id=\"local_xlate_course_job_owner\" style=\"font-weight:600\"></span>' +\n                                        '<span id=\"local_xlate_course_job_status\" style=\"margin-left:8px; color:#666\"></span>' +\n                                        '<span id=\"local_xlate_course_job_langs\" style=\"float:right; font-size:90%\"></span>' +\n                                    '</div>' +\n                                    '<div class=\"progress\" role=\"progressbar\" aria-label=\"Autotranslate progress\">' +\n                                        // Use Bootstrap striped + animated classes for nicer effect\n                                        '<div id=\"local_xlate_course_progress_bar\" class=\"progress-bar progress-bar-striped progress-bar-animated bg-info\" style=\"width:0%\" aria-valuemin=\"0\" aria-valuemax=\"100\">0%</div>' +\n                                    '</div>' +\n                                    '<div id=\"local_xlate_course_progress_text\" style=\"margin-top:6px; font-size:90%\">0 / 0</div>' +\n                                '</div>';\n                    parent.insertBefore(wrapper, parent.firstChild);\n                } catch (e) {\n                    // ignore DOM insertion errors\n                }\n            }\n\n            // If there's no course button (no card), keep going — we still may\n            // need to resume polling for an active job.\n\n            // per-item autotranslate removed — we only support course-level autotranslate now.\n\n            // per-item autotranslate removed — we only support course-level autotranslate now.\n\n            // Course-level autotranslate: enqueue a job for the current course\n            if (courseButton) {\n                courseButton.addEventListener('click', function () {\n                    // Determine course id from config or global window variable\n                    var courseid = 0;\n                    if (typeof window !== 'undefined' && typeof window.XLATE_COURSEID !== 'undefined') {\n                        courseid = window.XLATE_COURSEID || 0;\n                    } else if (config && config.courseid) {\n                        courseid = config.courseid || 0;\n                    }\n\n                    if (!courseid) {\n                        notification.alert('Please navigate to this page with a valid course filter to autotranslate the course.');\n                        return;\n                    }\n\n                    // Determine targets same as the key-based autotranslate flow\n                    var targets = [];\n                    var checked = document.querySelectorAll('input[name=\"local_xlate_target[]\"]:checked');\n                    if (checked && checked.length) {\n                        for (var ci = 0; ci < checked.length; ci++) {\n                            var val = checked[ci].value || '';\n                            if (val) {\n                                targets.push(val.toString().trim());\n                            }\n                        }\n                    } else {\n                        var targetEl = document.getElementById('local_xlate_target');\n                        if (targetEl) {\n                            if (targetEl.multiple) {\n                                for (var si = 0; si < targetEl.options.length; si++) {\n                                    if (targetEl.options[si].selected) {\n                                        targets.push((targetEl.options[si].value || '').toString().trim());\n                                    }\n                                }\n                            } else {\n                                var v = targetEl.value || '';\n                                if (v) { targets.push(v.toString().trim()); }\n                            }\n                        } else {\n                            var targetcfg = (config && config.defaulttarget) ? config.defaulttarget : '';\n                            targets = Array.isArray(targetcfg) ? targetcfg : [targetcfg];\n                        }\n                    }\n\n                    if (!targets.length) {\n                        notification.alert('No target languages selected for course autotranslate.');\n                        return;\n                    }\n\n                    var options = {\n                        batchsize: (config && config.batchsize) ? config.batchsize : 50,\n                        targetlang: targets,\n                        sourcelang: config && config.sourcelang ? config.sourcelang : 'en'\n                    };\n\n                    var call = Ajax.call([{\n                        methodname: 'local_xlate_autotranslate_course_enqueue',\n                        args: {\n                            courseid: courseid,\n                            options: options\n                        }\n                    }])[0];\n\n                    call.then(function (res) {\n                        if (!(res && res.success)) {\n                            notification.alert('Failed to enqueue course autotranslate job.');\n                            return;\n                        }\n                        notification.alert('Course autotranslate job queued. Job id: ' + (res.jobid || 'n/a'));\n                        // Start polling job progress\n                        startCoursePolling(res.jobid);\n                    }).catch(function (err) {\n                        notification.alert('Error enqueuing course job: ' + (err && err.message ? err.message : String(err)));\n                    });\n                });\n            }\n\n            // If the server detected an active job for this course, resume polling\n            if (config && config.currentjobid) {\n                try {\n                    startCoursePolling(config.currentjobid);\n                } catch (e) {\n                    // ignore any errors starting the resumed poll\n                }\n            }\n\n            function startCoursePolling(jobid) {\n                if (!jobid) { return; }\n\n                var container = document.getElementById('local_xlate_course_progress');\n                var bar = document.getElementById('local_xlate_course_progress_bar');\n                var text = document.getElementById('local_xlate_course_progress_text');\n                if (!container || !bar || !text) {\n                    // Nothing to update on the page; bail out.\n                    return;\n                }\n\n                // Show the inline progress container\n                container.style.display = 'block';\n\n                // Initialize owner/status from server-provided config when available.\n                if (config) {\n                    var ownerEl = document.getElementById('local_xlate_course_job_owner');\n                    var statusEl = document.getElementById('local_xlate_course_job_status');\n                    if (ownerEl && config.currentjobowner) {\n                        ownerEl.textContent = 'Job by ' + config.currentjobowner;\n                    }\n                    if (statusEl && config.currentjobstatus) {\n                        statusEl.textContent = '(' + config.currentjobstatus + ')';\n                    }\n                    // Show languages being translated (targetlang and sourcelang)\n                    var langsEl = document.getElementById('local_xlate_course_job_langs');\n                    if (langsEl) {\n                        var parts = [];\n                        if (config.currentjobsourcelang) {\n                            parts.push(config.currentjobsourcelang + ' →');\n                        }\n                        if (config.currentjobtargetlang) {\n                            if (Array.isArray(config.currentjobtargetlang)) {\n                                parts.push(config.currentjobtargetlang.join(', '));\n                            } else {\n                                parts.push(config.currentjobtargetlang);\n                            }\n                        }\n                        if (parts.length) {\n                            langsEl.textContent = parts.join(' ');\n                        }\n                    }\n                    if (config.currentjobprocessed !== undefined && config.currentjobtotal !== undefined) {\n                        text.textContent = config.currentjobprocessed + ' / ' + config.currentjobtotal;\n                        var pct = config.currentjobtotal > 0 ? Math.round((config.currentjobprocessed / config.currentjobtotal) * 100) : 0;\n                        bar.style.width = pct + '%';\n                        bar.setAttribute('aria-valuenow', pct);\n                        bar.textContent = pct + '%';\n                    }\n                }\n\n                var tries = 0;\n                var maxTries = 120;\n                var pollInterval = 5000;\n\n                var handle = setInterval(function () {\n                    tries = tries + 1;\n                    Ajax.call([{\n                        methodname: 'local_xlate_autotranslate_course_progress',\n                        args: { jobid: jobid }\n                    }])[0].then(function (res) {\n                        if (!(res && res.success && res.job)) { return; }\n                        var job = res.job;\n                        var total = job.total || 0;\n                        var processed = job.processed || 0;\n                        var percent = total > 0 ? Math.round((processed / total) * 100) : 0;\n\n                        // Update progress bar and numeric text\n                        bar.style.width = percent + '%';\n                        bar.setAttribute('aria-valuenow', percent);\n                        bar.textContent = percent + '%';\n                        text.textContent = processed + ' / ' + total;\n\n                        if (job.status === 'complete' || processed >= total) {\n                            clearInterval(handle);\n                            bar.style.width = '100%';\n                            bar.setAttribute('aria-valuenow', 100);\n                            bar.textContent = '100%';\n                            text.textContent = (processed || total) + ' / ' + total + ' — complete';\n                            notification.alert('Course autotranslate complete: ' + processed + ' / ' + total);\n                        } else if (tries >= maxTries) {\n                            clearInterval(handle);\n                            notification.alert('Course autotranslate polling timed out: ' + processed + ' / ' + total);\n                        }\n                    }).catch(function () {\n                        // ignore transient errors\n                    });\n                }, pollInterval);\n            }\n        }\n    };\n});\n"],"names":["define","Ajax","notification","init","config","courseButton","document","getElementById","currentjobid","parent","body","wrapper","createElement","id","style","margin","innerHTML","insertBefore","firstChild","e","addEventListener","courseid","window","XLATE_COURSEID","targets","checked","querySelectorAll","length","ci","val","value","push","toString","trim","targetEl","multiple","si","options","selected","v","targetcfg","defaulttarget","Array","isArray","batchsize","targetlang","sourcelang","call","methodname","args","then","res","success","alert","jobid","startCoursePolling","catch","err","message","String","container","bar","text","display","ownerEl","statusEl","currentjobowner","textContent","currentjobstatus","langsEl","parts","currentjobsourcelang","currentjobtargetlang","join","undefined","currentjobprocessed","currentjobtotal","pct","Math","round","width","setAttribute","tries","handle","setInterval","job","total","processed","percent","status","clearInterval"],"mappings":"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"}