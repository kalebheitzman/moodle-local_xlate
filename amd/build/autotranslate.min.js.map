{"version":3,"file":"autotranslate.min.js","sources":["../src/autotranslate.js"],"sourcesContent":["// AMD module to queue autotranslate for visible keys in Manage UI.\ndefine(['core/ajax', 'core/notification'], function (Ajax, notification) {\n    return {\n        init: function (config) {\n            var button = document.getElementById('local_xlate_autotranslate');\n            if (!button) {\n                return;\n            }\n\n            /**\n             * Start polling the server for persisted translations for items.\n             * This helper creates a small floating status panel and updates it.\n             * @param {string} targetlang\n             * @param {Array} items\n             */\n            function startPolling(targetlang, items) {\n                var statusId = 'local_xlate_autotranslate_status';\n                var statusEl = document.getElementById(statusId);\n                if (!statusEl) {\n                    statusEl = document.createElement('div');\n                    statusEl.id = statusId;\n                    statusEl.style.position = 'fixed';\n                    statusEl.style.right = '16px';\n                    statusEl.style.bottom = '16px';\n                    statusEl.style.zIndex = 1050;\n                    statusEl.style.maxWidth = '320px';\n                    statusEl.style.background = 'white';\n                    statusEl.style.border = '1px solid #ccc';\n                    statusEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';\n                    statusEl.style.padding = '12px';\n                    statusEl.style.borderRadius = '6px';\n                    document.body.appendChild(statusEl);\n                }\n\n                // Build an array of plain keys (hashes) for polling and display.\n                var plainids = [];\n                for (var pi = 0; pi < items.length; pi++) {\n                    plainids.push(items[pi].key || items[pi].id || '');\n                }\n                var total = plainids.length;\n                var translatedCount = 0;\n\n                /**\n                 * Render the status panel.\n                 * @param {Array} list\n                 */\n                function renderStatus(list) {\n                    var header = '<strong>Autotranslate</strong><br/>';\n                    var progressLine = '<div style=\"margin-top:8px\">' + translatedCount + ' / ' + total + ' translated</div>';\n                    var listContainer = '<div id=\"local_xlate_progress_list\" ' +\n                        'style=\"margin-top:8px; max-height:200px; overflow:auto; font-size:90%\"></div>';\n                    var closeButton = '<div style=\"margin-top:8px; text-align:right\">' +\n                        '<button id=\"local_xlate_progress_close\" class=\"btn btn-sm btn-secondary\">Close</button>' +\n                        '</div>';\n\n                    statusEl.innerHTML = header + progressLine + listContainer + closeButton;\n\n                    var listEl = document.getElementById('local_xlate_progress_list');\n                    listEl.innerHTML = '';\n                    for (var i = 0; i < list.length; i++) {\n                        var item = list[i];\n                        var row = document.createElement('div');\n                        row.style.padding = '2px 0';\n                        // Server now returns only the plain key (hash) as id; display that.\n                        row.textContent = (item.id || '') + ' — ' + (item.translated ? '✓' : '...');\n                        listEl.appendChild(row);\n                    }\n\n                    var closeBtn = document.getElementById('local_xlate_progress_close');\n                    if (closeBtn) {\n                        closeBtn.addEventListener('click', function () {\n                            if (statusEl && statusEl.parentNode) {\n                                statusEl.parentNode.removeChild(statusEl);\n                            }\n                        });\n                    }\n                }\n\n                var pollInterval = 3000;\n                var maxTries = 40;\n                var tries = 0;\n\n                var pollHandle = setInterval(function () {\n                    tries = tries + 1;\n                    // Poll using plain key/hashes only (not component:key).\n                    var ids = plainids.slice();\n\n                    var pcall = Ajax.call([{\n                        methodname: 'local_xlate_autotranslate_progress',\n                        args: {\n                            items: ids,\n                            targetlang: targetlang\n                        }\n                    }])[0];\n\n                    pcall.then(function (progress) {\n                        if (!(progress && progress.success && Array.isArray(progress.results))) {\n                            return null;\n                        }\n\n                        translatedCount = 0;\n                        for (var k = 0; k < progress.results.length; k++) {\n                            if (progress.results[k].translated) {\n                                translatedCount = translatedCount + 1;\n                            }\n                        }\n\n                        renderStatus(progress.results);\n\n                        if (translatedCount >= total) {\n                            clearInterval(pollHandle);\n                            notification.alert('Autotranslate finished: ' + translatedCount + ' / ' + total + ' translated.');\n                        } else if (tries >= maxTries) {\n                            clearInterval(pollHandle);\n                            notification.alert('Autotranslate polling timed out: ' + translatedCount + ' / ' + total + '.');\n                        }\n\n                        return null;\n                    }).catch(function () {\n                        return null;\n                    });\n                }, pollInterval);\n            }\n\n            button.addEventListener('click', function () {\n                // Collect visible key cards (component.xkey in strong inside card-header)\n                var cards = Array.prototype.slice.call(document.querySelectorAll('.card.mb-3'));\n                var items = [];\n                var pageCourseId = 0;\n                if (typeof window !== 'undefined' && typeof window.XLATE_COURSEID !== 'undefined') {\n                    pageCourseId = window.XLATE_COURSEID;\n                } else if (config && config.courseid) {\n                    pageCourseId = config.courseid;\n                }\n\n                cards.forEach(function (card) {\n                    try {\n                        var header = card.querySelector('.card-header strong');\n                        if (!header) {\n                            return;\n                        }\n                        var compkey = header.textContent.trim();\n                        if (!compkey || compkey.indexOf('.') === -1) {\n                            return;\n                        }\n                        var parts = compkey.split('.');\n                        var component = parts.slice(0, parts.length - 1).join('.');\n                        var xkey = parts[parts.length - 1];\n\n                        var sourceText = '';\n                        var srcel = card.querySelector('.form-control-plaintext');\n                        if (srcel) {\n                            sourceText = srcel.textContent.trim();\n                        }\n\n                        items.push({\n                            id: component + ':' + xkey,\n                            component: component,\n                            key: xkey,\n                            source_text: sourceText\n                        });\n                    } catch (e) {\n                        // Ignore parsing errors per-card\n                    }\n                });\n\n                if (!items.length) {\n                    notification.alert('No visible translation keys found on this page.');\n                    return;\n                }\n\n                // Determine target languages. Prefer a user-selected value from the\n                // Manage page select (`#local_xlate_target`) when present; otherwise\n                // fall back to the AMD `config.defaulttarget` value which may be a\n                // string or array.\n                var targets = [];\n                var targetEl = document.getElementById('local_xlate_target');\n                if (targetEl) {\n                    // Support both single-select and multi-select. Collect selected values.\n                    if (targetEl.multiple) {\n                        for (var si = 0; si < targetEl.options.length; si++) {\n                            if (targetEl.options[si].selected) {\n                                targets.push((targetEl.options[si].value || '').toString().trim());\n                            }\n                        }\n                    } else {\n                        var v = targetEl.value || '';\n                        if (v) {\n                            targets.push(v.toString().trim());\n                        }\n                    }\n                } else {\n                    var targetcfg = (config && config.defaulttarget) ? config.defaulttarget : '';\n                    targets = Array.isArray(targetcfg) ? targetcfg : [targetcfg];\n                }\n                // Trim/normalize and filter empty values\n                targets = targets.map(function (t) {\n                    return (t || '').toString().trim();\n                }).filter(function (t) {\n                    return t !== '';\n                });\n\n                if (!targets.length) {\n                    notification.alert('No default target language configured. Please specify a target language in the Manage UI.');\n                    return;\n                }\n\n                // Queue one task per target language.\n                targets.forEach(function (target) {\n                    var call = Ajax.call([{\n                        methodname: 'local_xlate_autotranslate',\n                        args: {\n                            sourcelang: config.sourcelang || 'en',\n                            // The server accepts an array of target languages; send as an array\n                            // even when queuing a single language so the external API validation\n                            // matches the webservice signature.\n                            targetlang: [target],\n                            items: items,\n                            glossary: config.glossary || [],\n                            options: {}\n                        }\n                    }])[0];\n\n                    /**\n                     * Extract a readable error message from various error shapes.\n                     * @param {*} err\n                     * @return {string}\n                     */\n                    function extractError(err) {\n                        try {\n                            if (!err) {\n                                return 'Unknown error';\n                            }\n                            if (typeof err === 'string') {\n                                return err;\n                            }\n                            if (err.error) {\n                                return (typeof err.error === 'string') ? err.error : JSON.stringify(err.error);\n                            }\n                            if (err.exception) {\n                                return err.exception + (err.message ? (': ' + err.message) : '');\n                            }\n                            if (err.message) {\n                                return err.message;\n                            }\n                            return JSON.stringify(err);\n                        } catch (e) {\n                            return String(err);\n                        }\n                    }\n\n                    call.then(function (res) {\n                        if (!(res && res.success)) {\n                            var reason = (res && (res.error || res.message)) ? (res.error || res.message) : null;\n                            var msg = 'Failed to queue autotranslate task for ' + target + (reason ? (': ' + reason) : '.');\n                            notification.alert(msg);\n                            return null;\n                        }\n\n                        notification.alert('Autotranslate task queued for ' + target + '. Task id: ' + (res.taskid || 'n/a'));\n                        // Start polling for persisted translations for this language.\n                        startPolling(target, items);\n\n                        return null;\n                    }).catch(function (err) {\n                        var detail = extractError(err);\n                        notification.alert('Error queuing autotranslate task for ' + target + ': ' + detail);\n                        return null;\n                    });\n                });\n            });\n        }\n    };\n});\n"],"names":["define","Ajax","notification","init","config","button","document","getElementById","startPolling","targetlang","items","statusId","statusEl","createElement","id","style","position","right","bottom","zIndex","maxWidth","background","border","boxShadow","padding","borderRadius","body","appendChild","plainids","pi","length","push","key","total","translatedCount","tries","pollHandle","setInterval","ids","slice","call","methodname","args","then","progress","success","Array","isArray","results","k","translated","list","progressLine","innerHTML","header","listEl","i","item","row","textContent","closeBtn","addEventListener","parentNode","removeChild","renderStatus","clearInterval","alert","catch","cards","prototype","querySelectorAll","window","XLATE_COURSEID","courseid","forEach","card","querySelector","compkey","trim","indexOf","parts","split","component","join","xkey","sourceText","srcel","source_text","e","targets","targetEl","multiple","si","options","selected","value","toString","v","targetcfg","defaulttarget","map","t","filter","target","sourcelang","glossary","res","reason","error","message","msg","taskid","err","detail","JSON","stringify","exception","String","extractError"],"mappings":"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"}