{"version":3,"file":"autotranslate.min.js","sources":["../src/autotranslate.js"],"sourcesContent":["// AMD module to queue autotranslate for visible keys in Manage UI.\ndefine(['core/ajax', 'core/notification'], function (Ajax, notification) {\n    return {\n        init: function (config) {\n            var courseButton = document.getElementById('local_xlate_autotranslate_course');\n            if (!courseButton) {\n                return;\n            }\n\n            /**\n             * Start polling the server for persisted translations for items.\n             * This helper creates a small floating status panel and updates it.\n             * @param {string} targetlang\n             * @param {Array} items\n             */\n            function startPolling(targetlang, items) {\n                var statusId = 'local_xlate_autotranslate_status';\n                var statusEl = document.getElementById(statusId);\n                if (!statusEl) {\n                    statusEl = document.createElement('div');\n                    statusEl.id = statusId;\n                    statusEl.style.position = 'fixed';\n                    statusEl.style.right = '16px';\n                    statusEl.style.bottom = '16px';\n                    statusEl.style.zIndex = 1050;\n                    statusEl.style.maxWidth = '320px';\n                    statusEl.style.background = 'white';\n                    statusEl.style.border = '1px solid #ccc';\n                    statusEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';\n                    statusEl.style.padding = '12px';\n                    statusEl.style.borderRadius = '6px';\n                    document.body.appendChild(statusEl);\n                }\n\n                // Build an array of plain keys (hashes) for polling and display.\n                var plainids = [];\n                for (var pi = 0; pi < items.length; pi++) {\n                    plainids.push(items[pi].key || items[pi].id || '');\n                }\n                var total = plainids.length;\n                var translatedCount = 0;\n\n                /**\n                 * Render the status panel.\n                 * @param {Array} list\n                 */\n                function renderStatus(list) {\n                    var header = '<strong>Autotranslate</strong><br/>';\n                    var progressLine = '<div style=\"margin-top:8px\">' + translatedCount + ' / ' + total + ' translated</div>';\n                    var listContainer = '<div id=\"local_xlate_progress_list\" ' +\n                        'style=\"margin-top:8px; max-height:200px; overflow:auto; font-size:90%\"></div>';\n                    var closeButton = '<div style=\"margin-top:8px; text-align:right\">' +\n                        '<button id=\"local_xlate_progress_close\" class=\"btn btn-sm btn-secondary\">Close</button>' +\n                        '</div>';\n\n                    statusEl.innerHTML = header + progressLine + listContainer + closeButton;\n\n                    var listEl = document.getElementById('local_xlate_progress_list');\n                    listEl.innerHTML = '';\n                    for (var i = 0; i < list.length; i++) {\n                        var item = list[i];\n                        var row = document.createElement('div');\n                        row.style.padding = '2px 0';\n                        // Server now returns only the plain key (hash) as id; display that.\n                        row.textContent = (item.id || '') + ' — ' + (item.translated ? '✓' : '...');\n                        listEl.appendChild(row);\n                    }\n\n                    var closeBtn = document.getElementById('local_xlate_progress_close');\n                    if (closeBtn) {\n                        closeBtn.addEventListener('click', function () {\n                            if (statusEl && statusEl.parentNode) {\n                                statusEl.parentNode.removeChild(statusEl);\n                            }\n                        });\n                    }\n                }\n\n                // Poll every 5s by default and allow longer total wait for slow cron\n                var pollInterval = 5000;\n                // Allow up to 120 tries -> ~10 minutes max (configurable)\n                var maxTries = 120;\n                // Per-request timeout (ms) to avoid a single stalled XHR blocking progress\n                var perRequestTimeout = 120000; // 2 minutes\n                var tries = 0;\n\n                var pollHandle = setInterval(function () {\n                    tries = tries + 1;\n                    // Poll using plain key/hashes only (not component:key).\n                    var ids = plainids.slice();\n\n                    // Wrap Ajax.call with a per-request timeout so a single slow request\n                    // doesn't block the whole polling loop.\n                    var ajaxPromise = Ajax.call([{\n                        methodname: 'local_xlate_autotranslate_progress',\n                        args: {\n                            items: ids,\n                            targetlang: targetlang\n                        }\n                    }])[0];\n\n                    var timeoutPromise = new Promise(function (resolve, reject) {\n                        setTimeout(function () {\n                            reject(new Error('progress request timed out'));\n                        }, perRequestTimeout);\n                    });\n\n                    Promise.race([ajaxPromise, timeoutPromise]).then(function (progress) {\n                        if (!(progress && progress.success && Array.isArray(progress.results))) {\n                            return null;\n                        }\n\n                        translatedCount = 0;\n                        for (var k = 0; k < progress.results.length; k++) {\n                            if (progress.results[k].translated) {\n                                translatedCount = translatedCount + 1;\n                            }\n                        }\n\n                        // Update Manage page inputs/textareas with any newly-persisted translations.\n                        try {\n                            // Build a quick map from item id -> component so we can find the\n                            // corresponding card on the Manage page. The original `items`\n                            // array is available in the closure.\n                            var keyToComponent = {};\n                            for (var pi = 0; pi < items.length; pi++) {\n                                var ik = items[pi].key || (items[pi].id || '');\n                                if (!ik) { continue; }\n                                keyToComponent[ik] = items[pi].component || '';\n                            }\n\n                            for (var r = 0; r < progress.results.length; r++) {\n                                var pres = progress.results[r];\n                                if (pres && pres.translated && pres.translation) {\n                                    var xkey = pres.id;\n                                    var comp = keyToComponent[xkey] || '';\n                                    // Compose the header text that Manage page uses: component.xkey\n                                    var headerText = (comp ? (comp + '.' + xkey) : xkey).trim();\n                                    // Find the card with that header\n                                    var cardEls = document.querySelectorAll('.card.mb-3');\n                                    for (var ci = 0; ci < cardEls.length; ci++) {\n                                        try {\n                                            var header = cardEls[ci].querySelector('.card-header strong');\n                                            if (!header) { continue; }\n                                            if (header.textContent.trim() !== headerText) { continue; }\n                                            // Within this card, find the form for targetlang and set its translation value\n                                            var form = cardEls[ci].querySelector('form input[name=\"lang\"][value=\"' + targetlang + '\"]');\n                                            if (form) {\n                                                var parentForm = form.closest('form');\n                                                if (parentForm) {\n                                                    var txt = parentForm.querySelector('[name=\"translation\"]');\n                                                    if (txt) {\n                                                        if (txt.tagName && txt.tagName.toLowerCase() === 'textarea') {\n                                                            txt.value = pres.translation;\n                                                        } else {\n                                                            txt.value = pres.translation;\n                                                        }\n                                                        // dispatch input/change events so any listeners update\n                                                        txt.dispatchEvent(new Event('input', { bubbles: true }));\n                                                        txt.dispatchEvent(new Event('change', { bubbles: true }));\n                                                    }\n                                                }\n                                            }\n                                        } catch (e) {\n                                            // ignore per-card errors\n                                        }\n                                    }\n                                }\n                            }\n                        } catch (e) {\n                            // don't let UI update errors break polling\n                        }\n\n                        renderStatus(progress.results);\n\n                        if (translatedCount >= total) {\n                            clearInterval(pollHandle);\n                            notification.alert('Autotranslate finished: ' + translatedCount + ' / ' + total + ' translated.');\n                        } else if (tries >= maxTries) {\n                            clearInterval(pollHandle);\n                            notification.alert('Autotranslate polling timed out: ' + translatedCount + ' / ' + total + '.');\n                        }\n\n                        return null;\n                    }).catch(function () {\n                        return null;\n                    });\n                }, pollInterval);\n            }\n\n            // per-item autotranslate removed — we only support course-level autotranslate now.\n\n            // Course-level autotranslate: enqueue a job for the current course\n            if (courseButton) {\n                courseButton.addEventListener('click', function () {\n                    // Determine course id from config or global window variable\n                    var courseid = 0;\n                    if (typeof window !== 'undefined' && typeof window.XLATE_COURSEID !== 'undefined') {\n                        courseid = window.XLATE_COURSEID || 0;\n                    } else if (config && config.courseid) {\n                        courseid = config.courseid || 0;\n                    }\n\n                    if (!courseid) {\n                        notification.alert('Please navigate to this page with a valid course filter to autotranslate the course.');\n                        return;\n                    }\n\n                    // Determine targets same as the key-based autotranslate flow\n                    var targets = [];\n                    var checked = document.querySelectorAll('input[name=\"local_xlate_target[]\"]:checked');\n                    if (checked && checked.length) {\n                        for (var ci = 0; ci < checked.length; ci++) {\n                            var val = checked[ci].value || '';\n                            if (val) {\n                                targets.push(val.toString().trim());\n                            }\n                        }\n                    } else {\n                        var targetEl = document.getElementById('local_xlate_target');\n                        if (targetEl) {\n                            if (targetEl.multiple) {\n                                for (var si = 0; si < targetEl.options.length; si++) {\n                                    if (targetEl.options[si].selected) {\n                                        targets.push((targetEl.options[si].value || '').toString().trim());\n                                    }\n                                }\n                            } else {\n                                var v = targetEl.value || '';\n                                if (v) { targets.push(v.toString().trim()); }\n                            }\n                        } else {\n                            var targetcfg = (config && config.defaulttarget) ? config.defaulttarget : '';\n                            targets = Array.isArray(targetcfg) ? targetcfg : [targetcfg];\n                        }\n                    }\n\n                    if (!targets.length) {\n                        notification.alert('No target languages selected for course autotranslate.');\n                        return;\n                    }\n\n                    var options = {\n                        batchsize: (config && config.batchsize) ? config.batchsize : 50,\n                        targetlang: targets,\n                        sourcelang: config && config.sourcelang ? config.sourcelang : 'en'\n                    };\n\n                    var call = Ajax.call([{\n                        methodname: 'local_xlate_autotranslate_course_enqueue',\n                        args: {\n                            courseid: courseid,\n                            options: options\n                        }\n                    }])[0];\n\n                    call.then(function (res) {\n                        if (!(res && res.success)) {\n                            notification.alert('Failed to enqueue course autotranslate job.');\n                            return;\n                        }\n                        notification.alert('Course autotranslate job queued. Job id: ' + (res.jobid || 'n/a'));\n                        // Start polling job progress\n                        startCoursePolling(res.jobid);\n                    }).catch(function (err) {\n                        notification.alert('Error enqueuing course job: ' + (err && err.message ? err.message : String(err)));\n                    });\n                });\n            }\n\n            function startCoursePolling(jobid) {\n                if (!jobid) { return; }\n                var statusId = 'local_xlate_course_autotranslate_status';\n                var statusEl = document.getElementById(statusId);\n                if (!statusEl) {\n                    statusEl = document.createElement('div');\n                    statusEl.id = statusId;\n                    statusEl.style.position = 'fixed';\n                    statusEl.style.left = '16px';\n                    statusEl.style.bottom = '16px';\n                    statusEl.style.zIndex = 1050;\n                    statusEl.style.maxWidth = '420px';\n                    statusEl.style.background = 'white';\n                    statusEl.style.border = '1px solid #ccc';\n                    statusEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';\n                    statusEl.style.padding = '12px';\n                    statusEl.style.borderRadius = '6px';\n                    document.body.appendChild(statusEl);\n                }\n\n                var tries = 0;\n                var maxTries = 120;\n                var pollInterval = 5000;\n\n                var handle = setInterval(function () {\n                    tries = tries + 1;\n                    Ajax.call([{\n                        methodname: 'local_xlate_autotranslate_course_progress',\n                        args: { jobid: jobid }\n                    }])[0].then(function (res) {\n                        if (!(res && res.success && res.job)) { return; }\n                        var job = res.job;\n                        statusEl.innerHTML = '<strong>Course Autotranslate</strong><br/>' +\n                            'Status: ' + job.status + '<br/>' +\n                            'Processed: ' + job.processed + ' / ' + job.total + '<br/>' +\n                            '<div style=\"margin-top:8px;text-align:right\"><button id=\"local_xlate_course_status_close\" class=\"btn btn-sm btn-secondary\">Close</button></div>';\n\n                        var closeBtn = document.getElementById('local_xlate_course_status_close');\n                        if (closeBtn) {\n                            closeBtn.addEventListener('click', function () {\n                                if (statusEl && statusEl.parentNode) { statusEl.parentNode.removeChild(statusEl); }\n                            });\n                        }\n\n                        if (job.status === 'complete' || job.processed >= job.total) {\n                            clearInterval(handle);\n                            notification.alert('Course autotranslate complete: ' + job.processed + ' / ' + job.total);\n                        } else if (tries >= maxTries) {\n                            clearInterval(handle);\n                            notification.alert('Course autotranslate polling timed out: ' + job.processed + ' / ' + job.total);\n                        }\n                    }).catch(function () {\n                        // ignore transient errors\n                    });\n                }, pollInterval);\n            }\n        }\n    };\n});\n"],"names":["define","Ajax","notification","init","config","courseButton","document","getElementById","addEventListener","courseid","window","XLATE_COURSEID","targets","checked","querySelectorAll","length","ci","val","value","push","toString","trim","targetEl","multiple","si","options","selected","v","targetcfg","defaulttarget","Array","isArray","batchsize","targetlang","sourcelang","call","methodname","args","then","res","success","alert","jobid","statusId","statusEl","createElement","id","style","position","left","bottom","zIndex","maxWidth","background","border","boxShadow","padding","borderRadius","body","appendChild","tries","maxTries","handle","setInterval","job","innerHTML","status","processed","total","closeBtn","parentNode","removeChild","clearInterval","catch","startCoursePolling","err","message","String"],"mappings":"AACAA,mCAAO,CAAC,YAAa,sBAAsB,SAAUC,KAAMC,oBAChD,CACHC,KAAM,SAAUC,YACRC,aAAeC,SAASC,eAAe,oCACtCF,cA4LDA,cACAA,aAAaG,iBAAiB,SAAS,eAE/BC,SAAW,KACO,oBAAXC,aAA2D,IAA1BA,OAAOC,eAC/CF,SAAWC,OAAOC,gBAAkB,EAC7BP,QAAUA,OAAOK,WACxBA,SAAWL,OAAOK,UAAY,GAG7BA,cAMDG,QAAU,GACVC,QAAUP,SAASQ,iBAAiB,iDACpCD,SAAWA,QAAQE,WACd,IAAIC,GAAK,EAAGA,GAAKH,QAAQE,OAAQC,KAAM,KACpCC,IAAMJ,QAAQG,IAAIE,OAAS,GAC3BD,KACAL,QAAQO,KAAKF,IAAIG,WAAWC,YAGjC,KACCC,SAAWhB,SAASC,eAAe,yBACnCe,YACIA,SAASC,aACJ,IAAIC,GAAK,EAAGA,GAAKF,SAASG,QAAQV,OAAQS,KACvCF,SAASG,QAAQD,IAAIE,UACrBd,QAAQO,MAAMG,SAASG,QAAQD,IAAIN,OAAS,IAAIE,WAAWC,YAGhE,KACCM,EAAIL,SAASJ,OAAS,GACtBS,GAAKf,QAAQO,KAAKQ,EAAEP,WAAWC,YAEpC,KACCO,UAAaxB,QAAUA,OAAOyB,cAAiBzB,OAAOyB,cAAgB,GAC1EjB,QAAUkB,MAAMC,QAAQH,WAAaA,UAAY,CAACA,eAIrDhB,QAAQG,YAKTU,QAAU,CACVO,UAAY5B,QAAUA,OAAO4B,UAAa5B,OAAO4B,UAAY,GAC7DC,WAAYrB,QACZsB,WAAY9B,QAAUA,OAAO8B,WAAa9B,OAAO8B,WAAa,MAGvDjC,KAAKkC,KAAK,CAAC,CAClBC,WAAY,2CACZC,KAAM,CACF5B,SAAUA,SACVgB,QAASA,YAEb,GAECa,MAAK,SAAUC,KACVA,KAAOA,IAAIC,SAIjBtC,aAAauC,MAAM,6CAA+CF,IAAIG,OAAS,iBAS/DA,WACnBA,iBACDC,SAAW,0CACXC,SAAWtC,SAASC,eAAeoC,UAClCC,YACDA,SAAWtC,SAASuC,cAAc,QACzBC,GAAKH,SACdC,SAASG,MAAMC,SAAW,QAC1BJ,SAASG,MAAME,KAAO,OACtBL,SAASG,MAAMG,OAAS,OACxBN,SAASG,MAAMI,OAAS,KACxBP,SAASG,MAAMK,SAAW,QAC1BR,SAASG,MAAMM,WAAa,QAC5BT,SAASG,MAAMO,OAAS,iBACxBV,SAASG,MAAMQ,UAAY,4BAC3BX,SAASG,MAAMS,QAAU,OACzBZ,SAASG,MAAMU,aAAe,MAC9BnD,SAASoD,KAAKC,YAAYf,eAG1BgB,MAAQ,EACRC,SAAW,IAGXC,OAASC,aAAY,WACrBH,OAAgB,EAChB3D,KAAKkC,KAAK,CAAC,CACPC,WAAY,4CACZC,KAAM,CAAEK,MAAOA,UACf,GAAGJ,MAAK,SAAUC,QACZA,KAAOA,IAAIC,SAAWD,IAAIyB,SAC5BA,IAAMzB,IAAIyB,IACdpB,SAASqB,UAAY,qDACJD,IAAIE,OADA,mBAEDF,IAAIG,UAAY,MAAQH,IAAII,MAF3B,2JAKjBC,SAAW/D,SAASC,eAAe,mCACnC8D,UACAA,SAAS7D,iBAAiB,SAAS,WAC3BoC,UAAYA,SAAS0B,YAAc1B,SAAS0B,WAAWC,YAAY3B,aAI5D,aAAfoB,IAAIE,QAAyBF,IAAIG,WAAaH,IAAII,OAClDI,cAAcV,QACd5D,aAAauC,MAAM,kCAAoCuB,IAAIG,UAAY,MAAQH,IAAII,QAC5ER,OAASC,WAChBW,cAAcV,QACd5D,aAAauC,MAAM,2CAA6CuB,IAAIG,UAAY,MAAQH,IAAII,YAEjGK,OAAM,iBA7BM,KA7BXC,CAAmBnC,IAAIG,QALnBxC,aAAauC,MAAM,kDAMxBgC,OAAM,SAAUE,KACfzE,aAAauC,MAAM,gCAAkCkC,KAAOA,IAAIC,QAAUD,IAAIC,QAAUC,OAAOF,eA3B/FzE,aAAauC,MAAM,+DAlCnBvC,aAAauC,MAAM"}