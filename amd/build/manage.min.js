define("local_xlate/manage",["core/ajax","core/notification"],(function(Ajax,notification){function getString(config,key,fallback){return config&&config.strings&&config.strings[key]?config.strings[key]:fallback}function findParentForm(element){if(!element)return null;if("function"==typeof element.closest)return element.closest("form");for(var node=element;node&&node.tagName&&"form"!==node.tagName.toLowerCase();)node=node.parentNode;return node&&node.tagName&&"form"===node.tagName.toLowerCase()?node:null}function deleteTranslation(button,config){if(button){var keyid=parseInt(button.getAttribute("data-keyid"),10)||0,lang=button.getAttribute("data-lang")||"";if(keyid&&lang){var failureMessage=getString(config,"deleteFailed","Unable to delete translation."),successMessage=getString(config,"deleteSuccess","Translation deleted.");button.disabled=!0,Ajax.call([{methodname:"local_xlate_delete_translation",args:{keyid:keyid,lang:lang}}])[0].then((function(res){res&&res.success?(!function(button){if(button){var form=findParentForm(button);if(form){var field=form.querySelector('[name="translation"]');field&&(field.value="");var toggles=form.querySelectorAll('input[name="status"], input[name="reviewed"]');toggles&&toggles.length&&Array.prototype.forEach.call(toggles,(function(toggle){toggle.checked=!1}))}}}(button),notification.addNotification({message:successMessage,type:"success"})):notification.alert(failureMessage),button.disabled=!1})).catch((function(err){var msg=failureMessage;err&&err.message?msg+="\n"+err.message:err&&err.error&&(msg+="\n"+err.error),notification.alert(msg),button.disabled=!1}))}}}function toggleButtonLoading(button,loading){if(button)if(loading){button.dataset.originalHtml||(button.dataset.originalHtml=button.innerHTML,button.dataset.originalLabel=button.textContent||"Autotranslate"),button.disabled=!0;var label=button.dataset.originalLabel||"";button.innerHTML='<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>'+label}else button.dataset.originalHtml&&(button.innerHTML=button.dataset.originalHtml,delete button.dataset.originalHtml),button.dataset.originalLabel&&delete button.dataset.originalLabel,button.disabled=!1}function attachAutoTranslateHandlers(config){var buttons=document.querySelectorAll(".js-xlate-auto-translate");buttons&&buttons.length&&Array.prototype.forEach.call(buttons,(function(button){button.addEventListener("click",(function(event){event.preventDefault(),button.disabled||function(button,config){if(button){var keyid=parseInt(button.getAttribute("data-keyid"),10)||0,targetlang=button.getAttribute("data-lang")||"";if(keyid&&targetlang){var form=findParentForm(button),textarea=form?form.querySelector('[name="translation"]'):null,statusToggle=form?form.querySelector('input[name="status"]'):null,reviewedToggle=form?form.querySelector('input[name="reviewed"]'):null,args={keyid:keyid,targetlang:targetlang,autosave:!0},courseid=config&&config.courseid&&parseInt(config.courseid,10)||0;courseid>0&&(args.courseid=courseid),toggleButtonLoading(button,!0),Ajax.call([{methodname:"local_xlate_autotranslate_key",args:args}])[0].then((function(res){if(toggleButtonLoading(button,!1),!res||!res.success||"string"!=typeof res.translation){var failureMessage=getString(config,"autoTranslateFailed","Autotranslate failed.");return res&&res.error&&(failureMessage+="\n"+res.error),void notification.alert(failureMessage)}if(textarea){textarea.value=res.translation;try{textarea.dispatchEvent(new Event("input",{bubbles:!0}))}catch(e){var evt=document.createEvent("Event");evt.initEvent("input",!0,!0),textarea.dispatchEvent(evt)}}reviewedToggle&&(reviewedToggle.checked=!1),statusToggle&&(statusToggle.checked=!0);var successKey=res&&res.saved?"autoTranslateSaved":"autoTranslateReady",successMessage=getString(config,successKey,"autoTranslateSaved"===successKey?"Autotranslation saved and marked active.":"Autotranslation inserted. Review and save.");notification.addNotification({message:successMessage,type:"success"})})).catch((function(err){toggleButtonLoading(button,!1);var failureMessage=getString(config,"autoTranslateFailed","Autotranslate failed.");err&&err.message?failureMessage+="\n"+err.message:err&&err.error&&(failureMessage+="\n"+err.error),notification.alert(failureMessage)}))}}}(button,config)}))}))}return{init:function(config){!function(config){var buttons=document.querySelectorAll(".js-xlate-delete-translation");if(buttons&&buttons.length){var confirmMessage=getString(config,"confirmDelete","Delete this translation?"),confirmTitle=getString(config,"confirmDeleteTitle","Delete translation"),confirmAction=getString(config,"confirmDeleteAction","Confirm"),cancelLabel=getString(config,"confirmDeleteCancel","Cancel");Array.prototype.forEach.call(buttons,(function(button){button.addEventListener("click",(function(event){event.preventDefault(),button.disabled||notification.confirm(confirmTitle,confirmMessage,confirmAction,cancelLabel,(function(){deleteTranslation(button,config)}))}))}))}}(config),attachAutoTranslateHandlers(config);var courseButton=document.getElementById("local_xlate_autotranslate_course");if(config&&config.currentjobid&&!document.getElementById("local_xlate_course_progress"))try{var parent=document.getElementById("region-main")||document.body,wrapper=document.createElement("div");wrapper.id="local_xlate_course_progress_wrapper",wrapper.style.margin="12px 0",wrapper.innerHTML='<div id="local_xlate_course_progress" style="display:block;"><div style="font-size:90%; margin-bottom:6px"><span id="local_xlate_course_job_owner" style="font-weight:600"></span><span id="local_xlate_course_job_status" style="margin-left:8px; color:#666"></span><span id="local_xlate_course_job_langs" style="float:right; font-size:90%"></span></div><div class="progress" role="progressbar" aria-label="Autotranslate progress"><div id="local_xlate_course_progress_bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width:0%" aria-valuemin="0" aria-valuemax="100">0%</div></div><div id="local_xlate_course_progress_text" style="margin-top:6px; font-size:90%">0 / 0</div></div>',parent.insertBefore(wrapper,parent.firstChild)}catch(e){}if(courseButton&&courseButton.addEventListener("click",(function(){var courseid=0;if("undefined"!=typeof window&&void 0!==window.XLATE_COURSEID?courseid=window.XLATE_COURSEID||0:config&&config.courseid&&(courseid=config.courseid||0),courseid){var selectedTargets=[],targetInputs=document.querySelectorAll('#local_xlate_target_container input[type="checkbox"]');if(targetInputs&&targetInputs.length&&(selectedTargets=Array.prototype.filter.call(targetInputs,(function(input){return!!input.checked})).map((function(input){return input.value}))),selectedTargets.length){var options={batchsize:config&&config.batchsize?config.batchsize:50,targetlang:selectedTargets};Ajax.call([{methodname:"local_xlate_autotranslate_course_enqueue",args:{courseid:courseid,options:options}}])[0].then((function(res){res&&res.success?(notification.alert("Course autotranslate job queued. Job id: "+(res.jobid||"n/a")),startCoursePolling(res.jobid)):notification.alert("Failed to enqueue course autotranslate job.")})).catch((function(err){var msg="Error enqueuing course job";err&&err.message?msg+=": "+err.message:err&&err.error&&(msg+=": "+err.error),-1===msg.toLowerCase().indexOf("language")&&-1===msg.toLowerCase().indexOf("configuration")||(msg+="\n\nPlease configure source and target languages in the course settings (Xlate section)."),notification.alert(msg)}))}else notification.alert("Select at least one target language before enqueuing autotranslation.")}else notification.alert("Please navigate to this page with a valid course filter to autotranslate the course.")})),config&&config.currentjobid)try{startCoursePolling(config.currentjobid)}catch(e){}function startCoursePolling(jobid){if(jobid){var container=document.getElementById("local_xlate_course_progress"),bar=document.getElementById("local_xlate_course_progress_bar"),text=document.getElementById("local_xlate_course_progress_text");if(container&&bar&&text){if(container.style.display="block",config){var ownerEl=document.getElementById("local_xlate_course_job_owner"),statusEl=document.getElementById("local_xlate_course_job_status");ownerEl&&config.currentjobowner&&(ownerEl.textContent="Job by "+config.currentjobowner),statusEl&&config.currentjobstatus&&(statusEl.textContent="("+config.currentjobstatus+")");var langsEl=document.getElementById("local_xlate_course_job_langs");if(langsEl){var parts=[];config.currentjobsourcelang&&parts.push(config.currentjobsourcelang+" →"),config.currentjobtargetlang&&(Array.isArray(config.currentjobtargetlang)?parts.push(config.currentjobtargetlang.join(", ")):parts.push(config.currentjobtargetlang)),parts.length&&(langsEl.textContent=parts.join(" "))}if(void 0!==config.currentjobprocessed&&void 0!==config.currentjobtotal){text.textContent=config.currentjobprocessed+" / "+config.currentjobtotal;var pct=config.currentjobtotal>0?Math.round(config.currentjobprocessed/config.currentjobtotal*100):0;bar.style.width=pct+"%",bar.setAttribute("aria-valuenow",pct),bar.textContent=pct+"%"}}var tries=0,handle=setInterval((function(){tries+=1,Ajax.call([{methodname:"local_xlate_autotranslate_course_progress",args:{jobid:jobid}}])[0].then((function(res){if(res&&res.success&&res.job){var job=res.job,total=job.total||0,processed=job.processed||0,percent=total>0?Math.round(processed/total*100):0;bar.style.width=percent+"%",bar.setAttribute("aria-valuenow",percent),bar.textContent=percent+"%",text.textContent=processed+" / "+total,"complete"===job.status||processed>=total?(clearInterval(handle),bar.style.width="100%",bar.setAttribute("aria-valuenow",100),bar.textContent="100%",text.textContent=(processed||total)+" / "+total+" — complete",notification.alert("Course autotranslate complete: "+processed+" / "+total)):tries>=120&&(clearInterval(handle),notification.alert("Course autotranslate polling timed out: "+processed+" / "+total))}})).catch((function(){}))}),5e3)}}}}}}));

//# sourceMappingURL=manage.min.js.map